{"version":3,"sources":["lib/ng-file-upload.js"],"names":["window","XMLHttpRequest","FileAPI","shouldLoad","prototype","setRequestHeader","orig","header","value","val","Function","apply","arguments","ngFileUpload","angular","module","version","service","$http","$q","$timeout","upload","promisesCount","isResumeSupported","Blob","slice","resumeSupported","sendHttp","config","method","headers","deferred","_deferred","defer","promise","notifyProgress","e","notify","progressFunc","getNotifyEvent","n","_start","loaded","total","_file","size","type","lengthComputable","target","disableProgress","__setXHR_","xhr","addEventListener","__XHR","xhrFn","uploadWithAngular","then","r","_chunkSize","_finished","fileSize","Math","min","_end","resolve","reject","resumeSizeUrl","get","resp","resumeSizeResponseReader","data","parseInt","toString","resumeSize","success","fn","response","status","error","progress","abort","pause","origXhrFn","isUploadInProgress","rename","file","name","ngfName","jsonBlob","isString","JSON","stringify","blob","_ngfBlob","json","toJson","copy","obj","clone","key","hasOwnProperty","isFile","flashId","internal","toResumeFile","formData","append","floor","addFieldToFormData","undefined","isDate","toISOString","split","replace","_fileKey","isObject","$$ngfCircularDetection","k","objectKey","length","arrayKey","digestConfig","translateScalars","resumeChunkSize","transformRequest","isArray","push","FormData","fields","formDataAppender","_isDigested","http","ArrayBuffer","defaults","str","search","parseFloat","substring","urlToBlob","url","responseType","arrayBufferView","Uint8Array","matches","match","setDefaults","$parse","$compile","UploadExif","getAttrWithDefaults","attr","def","attrGetter","scope","params","attrVal","shouldUpdateOn","modelOptions","updateOn","indexOf","emptyPromise","d","args","rejectPromise","happyPromise","result","applyExifRotations","files","promises","forEach","f","i","$file","applyExifRotation","fixedFile","splice","all","resizeFile","ngModel","resizeVal","isResizeSupported","p","resizeWithParams","handleFile","pattern","validatePattern","resizeIf","width","height","$width","$height","resize","resizedFile","$error","$errorMessages","$errorParam","message","$ngfValidations","valid","applyModelValidation","updateModel","fileChange","evt","noDelay","update","invalidFiles","newFiles","dupFiles","isSingleModel","$$ngfPrevValidFiles","$$ngfPrevInvalidFiles","invalidFile","$setViewValue","$files","$newFiles","$duplicateFiles","$invalidFiles","$invalidFile","$event","invalidModel","assign","allNewFiles","prevValidFiles","prevInvalidFiles","invalids","valids","removeDuplicates","equals","f1","f2","$ngfOrigSize","isInPrevFiles","j","toArray","v","resizeAndUpdate","keep","concat","options","debounce","change","resizingFiles","validateAfterResize","validate","validationResult","validsFiles","invalidsFiles","index","$modelValue","allowInvalid","validFiles","isExifSupported","directive","Upload","generatedElems","isDelayedClickSupported","ua","m","androidFixMinorVersion","test","linkFileSelect","elem","isInputTypeFile","tagName","toLowerCase","fileChangeAttr","changeFn","fileList","__files_","registerModelChangeValidator","unwatches","$watch","fileElem","$observe","bindAttrToFileInput","label","updateId","attributes","attribute","createFileInput","element","css","el","ref","document","body","appendChild","clickHandler","detectSwipe","resetModel","contains","parent","bind","navigator","userAgent","setTimeout","click","initialTouchStartY","initialTouchStartX","touches","changedTouches","originalEvent","clientX","clientY","currentX","currentY","abs","stopPropagation","preventDefault","ie10SameFileSelectFix","parentNode","unbind","replaceWith","removeAttr","appVersion","$formatters","$on","remove","unwatch","g","ngfFixIE","restrict","require","link","UploadBase","base64DataUrl","count","dataUrl","urls","ff","$ngfDataUrl","disallowObjectUrl","$ngfBlobUrl","$$ngfDataUrlPromise","$$ngfBlobUrlPromise","FileReader","URL","webkitURL","createObjectURL","blobUrls","blobUrlsTotalSize","maxMemory","blobUrlsMaxMemory","maxLength","blobUrlsMaxQueueSize","revokeObjectURL","fileReader","onload","onerror","readAsDataURL","getTagType","linkFileDirective","directiveName","resizeParams","isBackground","constructDataUrl","src","removeClass","addClass","naturalWidth","clientWidth","naturalHeight","clientHeight","getComputedStyle","style","$compileProvider","imgSrcSanitizationWhitelist","aHrefSanitizationWhitelist","filter","UploadDataUrl","$sce","trustedUrl","trustAsResourceUrl","$ngfDataUrlFilterInProgress","globStringToRegex","regexp","excludes","RegExp","len","exclude","ratioToFloat","xIndex","$dirty","filesArray","markModelAsDirty","$setDirty","validation","$setValidity","getValidationAttr","validationName","dName","toUpperCase","substr","prevLength","ignoredErrors","runAllValidation","validateSync","totalSize","validateAsync","asyncFn","resolveResult","resolveInternal","imageDimensions","mediaDuration","$duration","deffer","values","isValid","$ngfWidth","$ngfHeight","$ngfDimensionPromise","img","on","secondsCounter","checkLoadErrorInCaseOfNoCallback","getElementsByTagName","$ngfDuration","$ngfDurationPromise","duration","checkLoadError","UploadValidate","calculateAspectRatioFit","srcWidth","srcHeight","maxWidth","maxHeight","centerCrop","ratio","max","marginX","marginY","imagen","quality","canvasElement","createElement","imageElement","setAttribute","imgWidth","imgHeight","removeChild","ratioFloat","imgRatio","dimensions","context","getContext","drawImage","toDataURL","dataUrltoBlob","dataurl","origSize","arr","mime","bstr","atob","u8arr","charCodeAt","Object","defineProperty","$ngfName","set","configurable","restoreExif","$window","linkDrop","dropAvailable","model","available","isDisabled","leaveTimeout","dragOverDelay","actualDragOverClass","b","dataTransfer","effectAllowed","dropEffect","cancel","calculateDragOverClass","clazz","$isDragging","$class","extractFilesAndUpdateModel","clipboardData","metaKey","ctrlKey","source","updateOnType","html","getData","extractFiles","items","extractFilesFromHtml","callback","dClass","delay","accept","allowDir","multiple","maxFiles","Number","MAX_VALUE","maxTotalSize","includeDir","traverseFileTree","entry","path","isDirectory","dirReader","createReader","entries","readEntries","results","Array","call","location","protocol","webkitGetAsEntry","getAsFile","item","div","UploadResize","readAsArrayBuffer","applyTransform","ctx","orientation","transform","readOrientation","reader","slicedFile","view","DataView","getUint16","byteLength","offset","marker","getUint32","little","tags","setUint16","fixedArrayBuffer","arrayBufferToBase64","buffer","binary","bytes","String","fromCharCode","btoa","canvas","resized","ExifRestorer","KEY_STR","encode64","input","output","chr1","chr2","chr3","enc1","enc2","enc3","enc4","isNaN","charAt","restore","origFileBase64","resizedFileBase64","rawImage","decode64","segments","slice2Segments","image","exifManipulation","exifArray","getExifArray","newImageArray","insertExif","seg","x","imageData","buf","separatePoint","mae","ato","array","rawImageArray","head","endPoint","base64test","exec","console","log"],"mappings":"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","file":"ng-file-upload.js","sourcesContent":["/**!\r\n * AngularJS file upload directives and services. Supoorts: file upload/drop/paste, resume, cancel/abort,\r\n * progress, resize, thumbnail, preview, validation and CORS\r\n * @author  Danial  <danial.farid@gmail.com>\r\n * @version 12.2.13\r\n */\r\n\r\nif (window.XMLHttpRequest && !(window.FileAPI && FileAPI.shouldLoad)) {\r\n  window.XMLHttpRequest.prototype.setRequestHeader = (function (orig) {\r\n    return function (header, value) {\r\n      if (header === '__setXHR_') {\r\n        var val = value(this);\r\n        // fix for angular < 1.2.0\r\n        if (val instanceof Function) {\r\n          val(this);\r\n        }\r\n      } else {\r\n        orig.apply(this, arguments);\r\n      }\r\n    };\r\n  })(window.XMLHttpRequest.prototype.setRequestHeader);\r\n}\r\n\r\nvar ngFileUpload = angular.module('ngFileUpload', []);\r\n\r\nngFileUpload.version = '12.2.13';\r\n\r\nngFileUpload.service('UploadBase', ['$http', '$q', '$timeout', function ($http, $q, $timeout) {\r\n  var upload = this;\r\n  upload.promisesCount = 0;\r\n\r\n  this.isResumeSupported = function () {\r\n    return window.Blob && window.Blob.prototype.slice;\r\n  };\r\n\r\n  var resumeSupported = this.isResumeSupported();\r\n\r\n  function sendHttp(config) {\r\n    config.method = config.method || 'POST';\r\n    config.headers = config.headers || {};\r\n\r\n    var deferred = config._deferred = config._deferred || $q.defer();\r\n    var promise = deferred.promise;\r\n\r\n    function notifyProgress(e) {\r\n      if (deferred.notify) {\r\n        deferred.notify(e);\r\n      }\r\n      if (promise.progressFunc) {\r\n        $timeout(function () {\r\n          promise.progressFunc(e);\r\n        });\r\n      }\r\n    }\r\n\r\n    function getNotifyEvent(n) {\r\n      if (config._start != null && resumeSupported) {\r\n        return {\r\n          loaded: n.loaded + config._start,\r\n          total: (config._file && config._file.size) || n.total,\r\n          type: n.type, config: config,\r\n          lengthComputable: true, target: n.target\r\n        };\r\n      } else {\r\n        return n;\r\n      }\r\n    }\r\n\r\n    if (!config.disableProgress) {\r\n      config.headers.__setXHR_ = function () {\r\n        return function (xhr) {\r\n          if (!xhr || !xhr.upload || !xhr.upload.addEventListener) return;\r\n          config.__XHR = xhr;\r\n          if (config.xhrFn) config.xhrFn(xhr);\r\n          xhr.upload.addEventListener('progress', function (e) {\r\n            e.config = config;\r\n            notifyProgress(getNotifyEvent(e));\r\n          }, false);\r\n          //fix for firefox not firing upload progress end, also IE8-9\r\n          xhr.upload.addEventListener('load', function (e) {\r\n            if (e.lengthComputable) {\r\n              e.config = config;\r\n              notifyProgress(getNotifyEvent(e));\r\n            }\r\n          }, false);\r\n        };\r\n      };\r\n    }\r\n\r\n    function uploadWithAngular() {\r\n      $http(config).then(function (r) {\r\n          if (resumeSupported && config._chunkSize && !config._finished && config._file) {\r\n            var fileSize = config._file && config._file.size || 0;\r\n            notifyProgress({\r\n                loaded: Math.min(config._end, fileSize),\r\n                total: fileSize,\r\n                config: config,\r\n                type: 'progress'\r\n              }\r\n            );\r\n            upload.upload(config, true);\r\n          } else {\r\n            if (config._finished) delete config._finished;\r\n            deferred.resolve(r);\r\n          }\r\n        }, function (e) {\r\n          deferred.reject(e);\r\n        }, function (n) {\r\n          deferred.notify(n);\r\n        }\r\n      );\r\n    }\r\n\r\n    if (!resumeSupported) {\r\n      uploadWithAngular();\r\n    } else if (config._chunkSize && config._end && !config._finished) {\r\n      config._start = config._end;\r\n      config._end += config._chunkSize;\r\n      uploadWithAngular();\r\n    } else if (config.resumeSizeUrl) {\r\n      $http.get(config.resumeSizeUrl).then(function (resp) {\r\n        if (config.resumeSizeResponseReader) {\r\n          config._start = config.resumeSizeResponseReader(resp.data);\r\n        } else {\r\n          config._start = parseInt((resp.data.size == null ? resp.data : resp.data.size).toString());\r\n        }\r\n        if (config._chunkSize) {\r\n          config._end = config._start + config._chunkSize;\r\n        }\r\n        uploadWithAngular();\r\n      }, function (e) {\r\n        throw e;\r\n      });\r\n    } else if (config.resumeSize) {\r\n      config.resumeSize().then(function (size) {\r\n        config._start = size;\r\n        if (config._chunkSize) {\r\n          config._end = config._start + config._chunkSize;\r\n        }\r\n        uploadWithAngular();\r\n      }, function (e) {\r\n        throw e;\r\n      });\r\n    } else {\r\n      if (config._chunkSize) {\r\n        config._start = 0;\r\n        config._end = config._start + config._chunkSize;\r\n      }\r\n      uploadWithAngular();\r\n    }\r\n\r\n\r\n    promise.success = function (fn) {\r\n      promise.then(function (response) {\r\n        fn(response.data, response.status, response.headers, config);\r\n      });\r\n      return promise;\r\n    };\r\n\r\n    promise.error = function (fn) {\r\n      promise.then(null, function (response) {\r\n        fn(response.data, response.status, response.headers, config);\r\n      });\r\n      return promise;\r\n    };\r\n\r\n    promise.progress = function (fn) {\r\n      promise.progressFunc = fn;\r\n      promise.then(null, null, function (n) {\r\n        fn(n);\r\n      });\r\n      return promise;\r\n    };\r\n    promise.abort = promise.pause = function () {\r\n      if (config.__XHR) {\r\n        $timeout(function () {\r\n          config.__XHR.abort();\r\n        });\r\n      }\r\n      return promise;\r\n    };\r\n    promise.xhr = function (fn) {\r\n      config.xhrFn = (function (origXhrFn) {\r\n        return function () {\r\n          if (origXhrFn) origXhrFn.apply(promise, arguments);\r\n          fn.apply(promise, arguments);\r\n        };\r\n      })(config.xhrFn);\r\n      return promise;\r\n    };\r\n\r\n    upload.promisesCount++;\r\n    if (promise['finally'] && promise['finally'] instanceof Function) {\r\n      promise['finally'](function () {\r\n        upload.promisesCount--;\r\n      });\r\n    }\r\n    return promise;\r\n  }\r\n\r\n  this.isUploadInProgress = function () {\r\n    return upload.promisesCount > 0;\r\n  };\r\n\r\n  this.rename = function (file, name) {\r\n    file.ngfName = name;\r\n    return file;\r\n  };\r\n\r\n  this.jsonBlob = function (val) {\r\n    if (val != null && !angular.isString(val)) {\r\n      val = JSON.stringify(val);\r\n    }\r\n    var blob = new window.Blob([val], {type: 'application/json'});\r\n    blob._ngfBlob = true;\r\n    return blob;\r\n  };\r\n\r\n  this.json = function (val) {\r\n    return angular.toJson(val);\r\n  };\r\n\r\n  function copy(obj) {\r\n    var clone = {};\r\n    for (var key in obj) {\r\n      if (obj.hasOwnProperty(key)) {\r\n        clone[key] = obj[key];\r\n      }\r\n    }\r\n    return clone;\r\n  }\r\n\r\n  this.isFile = function (file) {\r\n    return file != null && (file instanceof window.Blob || (file.flashId && file.name && file.size));\r\n  };\r\n\r\n  this.upload = function (config, internal) {\r\n    function toResumeFile(file, formData) {\r\n      if (file._ngfBlob) return file;\r\n      config._file = config._file || file;\r\n      if (config._start != null && resumeSupported) {\r\n        if (config._end && config._end >= file.size) {\r\n          config._finished = true;\r\n          config._end = file.size;\r\n        }\r\n        var slice = file.slice(config._start, config._end || file.size);\r\n        slice.name = file.name;\r\n        slice.ngfName = file.ngfName;\r\n        if (config._chunkSize) {\r\n          formData.append('_chunkSize', config._chunkSize);\r\n          formData.append('_currentChunkSize', config._end - config._start);\r\n          formData.append('_chunkNumber', Math.floor(config._start / config._chunkSize));\r\n          formData.append('_totalSize', config._file.size);\r\n        }\r\n        return slice;\r\n      }\r\n      return file;\r\n    }\r\n\r\n    function addFieldToFormData(formData, val, key) {\r\n      if (val !== undefined) {\r\n        if (angular.isDate(val)) {\r\n          val = val.toISOString();\r\n        }\r\n        if (angular.isString(val)) {\r\n          formData.append(key, val);\r\n        } else if (upload.isFile(val)) {\r\n          var file = toResumeFile(val, formData);\r\n          var split = key.split(',');\r\n          if (split[1]) {\r\n            file.ngfName = split[1].replace(/^\\s+|\\s+$/g, '');\r\n            key = split[0];\r\n          }\r\n          config._fileKey = config._fileKey || key;\r\n          formData.append(key, file, file.ngfName || file.name);\r\n        } else {\r\n          if (angular.isObject(val)) {\r\n            if (val.$$ngfCircularDetection) throw 'ngFileUpload: Circular reference in config.data. Make sure specified data for Upload.upload() has no circular reference: ' + key;\r\n\r\n            val.$$ngfCircularDetection = true;\r\n            try {\r\n              for (var k in val) {\r\n                if (val.hasOwnProperty(k) && k !== '$$ngfCircularDetection') {\r\n                  var objectKey = config.objectKey == null ? '[i]' : config.objectKey;\r\n                  if (val.length && parseInt(k) > -1) {\r\n                    objectKey = config.arrayKey == null ? objectKey : config.arrayKey;\r\n                  }\r\n                  addFieldToFormData(formData, val[k], key + objectKey.replace(/[ik]/g, k));\r\n                }\r\n              }\r\n            } finally {\r\n              delete val.$$ngfCircularDetection;\r\n            }\r\n          } else {\r\n            formData.append(key, val);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    function digestConfig() {\r\n      config._chunkSize = upload.translateScalars(config.resumeChunkSize);\r\n      config._chunkSize = config._chunkSize ? parseInt(config._chunkSize.toString()) : null;\r\n\r\n      config.headers = config.headers || {};\r\n      config.headers['Content-Type'] = undefined;\r\n      config.transformRequest = config.transformRequest ?\r\n        (angular.isArray(config.transformRequest) ?\r\n          config.transformRequest : [config.transformRequest]) : [];\r\n      config.transformRequest.push(function (data) {\r\n        var formData = new window.FormData(), key;\r\n        data = data || config.fields || {};\r\n        if (config.file) {\r\n          data.file = config.file;\r\n        }\r\n        for (key in data) {\r\n          if (data.hasOwnProperty(key)) {\r\n            var val = data[key];\r\n            if (config.formDataAppender) {\r\n              config.formDataAppender(formData, key, val);\r\n            } else {\r\n              addFieldToFormData(formData, val, key);\r\n            }\r\n          }\r\n        }\r\n\r\n        return formData;\r\n      });\r\n    }\r\n\r\n    if (!internal) config = copy(config);\r\n    if (!config._isDigested) {\r\n      config._isDigested = true;\r\n      digestConfig();\r\n    }\r\n\r\n    return sendHttp(config);\r\n  };\r\n\r\n  this.http = function (config) {\r\n    config = copy(config);\r\n    config.transformRequest = config.transformRequest || function (data) {\r\n        if ((window.ArrayBuffer && data instanceof window.ArrayBuffer) || data instanceof window.Blob) {\r\n          return data;\r\n        }\r\n        return $http.defaults.transformRequest[0].apply(this, arguments);\r\n      };\r\n    config._chunkSize = upload.translateScalars(config.resumeChunkSize);\r\n    config._chunkSize = config._chunkSize ? parseInt(config._chunkSize.toString()) : null;\r\n\r\n    return sendHttp(config);\r\n  };\r\n\r\n  this.translateScalars = function (str) {\r\n    if (angular.isString(str)) {\r\n      if (str.search(/kb/i) === str.length - 2) {\r\n        return parseFloat(str.substring(0, str.length - 2) * 1024);\r\n      } else if (str.search(/mb/i) === str.length - 2) {\r\n        return parseFloat(str.substring(0, str.length - 2) * 1048576);\r\n      } else if (str.search(/gb/i) === str.length - 2) {\r\n        return parseFloat(str.substring(0, str.length - 2) * 1073741824);\r\n      } else if (str.search(/b/i) === str.length - 1) {\r\n        return parseFloat(str.substring(0, str.length - 1));\r\n      } else if (str.search(/s/i) === str.length - 1) {\r\n        return parseFloat(str.substring(0, str.length - 1));\r\n      } else if (str.search(/m/i) === str.length - 1) {\r\n        return parseFloat(str.substring(0, str.length - 1) * 60);\r\n      } else if (str.search(/h/i) === str.length - 1) {\r\n        return parseFloat(str.substring(0, str.length - 1) * 3600);\r\n      }\r\n    }\r\n    return str;\r\n  };\r\n\r\n  this.urlToBlob = function(url) {\r\n    var defer = $q.defer();\r\n    $http({url: url, method: 'get', responseType: 'arraybuffer'}).then(function (resp) {\r\n      var arrayBufferView = new Uint8Array(resp.data);\r\n      var type = resp.headers('content-type') || 'image/WebP';\r\n      var blob = new window.Blob([arrayBufferView], {type: type});\r\n      var matches = url.match(/.*\\/(.+?)(\\?.*)?$/);\r\n      if (matches.length > 1) {\r\n        blob.name = matches[1];\r\n      }\r\n      defer.resolve(blob);\r\n    }, function (e) {\r\n      defer.reject(e);\r\n    });\r\n    return defer.promise;\r\n  };\r\n\r\n  this.setDefaults = function (defaults) {\r\n    this.defaults = defaults || {};\r\n  };\r\n\r\n  this.defaults = {};\r\n  this.version = ngFileUpload.version;\r\n}\r\n\r\n]);\r\n\r\nngFileUpload.service('Upload', ['$parse', '$timeout', '$compile', '$q', 'UploadExif', function ($parse, $timeout, $compile, $q, UploadExif) {\r\n  var upload = UploadExif;\r\n  upload.getAttrWithDefaults = function (attr, name) {\r\n    if (attr[name] != null) return attr[name];\r\n    var def = upload.defaults[name];\r\n    return (def == null ? def : (angular.isString(def) ? def : JSON.stringify(def)));\r\n  };\r\n\r\n  upload.attrGetter = function (name, attr, scope, params) {\r\n    var attrVal = this.getAttrWithDefaults(attr, name);\r\n    if (scope) {\r\n      try {\r\n        if (params) {\r\n          return $parse(attrVal)(scope, params);\r\n        } else {\r\n          return $parse(attrVal)(scope);\r\n        }\r\n      } catch (e) {\r\n        // hangle string value without single qoute\r\n        if (name.search(/min|max|pattern/i)) {\r\n          return attrVal;\r\n        } else {\r\n          throw e;\r\n        }\r\n      }\r\n    } else {\r\n      return attrVal;\r\n    }\r\n  };\r\n\r\n  upload.shouldUpdateOn = function (type, attr, scope) {\r\n    var modelOptions = upload.attrGetter('ngfModelOptions', attr, scope);\r\n    if (modelOptions && modelOptions.updateOn) {\r\n      return modelOptions.updateOn.split(' ').indexOf(type) > -1;\r\n    }\r\n    return true;\r\n  };\r\n\r\n  upload.emptyPromise = function () {\r\n    var d = $q.defer();\r\n    var args = arguments;\r\n    $timeout(function () {\r\n      d.resolve.apply(d, args);\r\n    });\r\n    return d.promise;\r\n  };\r\n\r\n  upload.rejectPromise = function () {\r\n    var d = $q.defer();\r\n    var args = arguments;\r\n    $timeout(function () {\r\n      d.reject.apply(d, args);\r\n    });\r\n    return d.promise;\r\n  };\r\n\r\n  upload.happyPromise = function (promise, data) {\r\n    var d = $q.defer();\r\n    promise.then(function (result) {\r\n      d.resolve(result);\r\n    }, function (error) {\r\n      $timeout(function () {\r\n        throw error;\r\n      });\r\n      d.resolve(data);\r\n    });\r\n    return d.promise;\r\n  };\r\n\r\n  function applyExifRotations(files, attr, scope) {\r\n    var promises = [upload.emptyPromise()];\r\n    angular.forEach(files, function (f, i) {\r\n      if (f.type.indexOf('image/jpeg') === 0 && upload.attrGetter('ngfFixOrientation', attr, scope, {$file: f})) {\r\n        promises.push(upload.happyPromise(upload.applyExifRotation(f), f).then(function (fixedFile) {\r\n          files.splice(i, 1, fixedFile);\r\n        }));\r\n      }\r\n    });\r\n    return $q.all(promises);\r\n  }\r\n\r\n  function resizeFile(files, attr, scope, ngModel) {\r\n    var resizeVal = upload.attrGetter('ngfResize', attr, scope);\r\n    if (!resizeVal || !upload.isResizeSupported() || !files.length) return upload.emptyPromise();\r\n    if (resizeVal instanceof Function) {\r\n      var defer = $q.defer();\r\n      return resizeVal(files).then(function (p) {\r\n        resizeWithParams(p, files, attr, scope, ngModel).then(function (r) {\r\n          defer.resolve(r);\r\n        }, function (e) {\r\n          defer.reject(e);\r\n        });\r\n      }, function (e) {\r\n        defer.reject(e);\r\n      });\r\n    } else {\r\n      return resizeWithParams(resizeVal, files, attr, scope, ngModel);\r\n    }\r\n  }\r\n\r\n  function resizeWithParams(params, files, attr, scope, ngModel) {\r\n    var promises = [upload.emptyPromise()];\r\n\r\n    function handleFile(f, i) {\r\n      if (f.type.indexOf('image') === 0) {\r\n        if (params.pattern && !upload.validatePattern(f, params.pattern)) return;\r\n        params.resizeIf = function (width, height) {\r\n          return upload.attrGetter('ngfResizeIf', attr, scope,\r\n            {$width: width, $height: height, $file: f});\r\n        };\r\n        var promise = upload.resize(f, params);\r\n        promises.push(promise);\r\n        promise.then(function (resizedFile) {\r\n          files.splice(i, 1, resizedFile);\r\n        }, function (e) {\r\n          f.$error = 'resize';\r\n          (f.$errorMessages = (f.$errorMessages || {})).resize = true;\r\n          f.$errorParam = (e ? (e.message ? e.message : e) + ': ' : '') + (f && f.name);\r\n          ngModel.$ngfValidations.push({name: 'resize', valid: false});\r\n          upload.applyModelValidation(ngModel, files);\r\n        });\r\n      }\r\n    }\r\n\r\n    for (var i = 0; i < files.length; i++) {\r\n      handleFile(files[i], i);\r\n    }\r\n    return $q.all(promises);\r\n  }\r\n\r\n  upload.updateModel = function (ngModel, attr, scope, fileChange, files, evt, noDelay) {\r\n    function update(files, invalidFiles, newFiles, dupFiles, isSingleModel) {\r\n      attr.$$ngfPrevValidFiles = files;\r\n      attr.$$ngfPrevInvalidFiles = invalidFiles;\r\n      var file = files && files.length ? files[0] : null;\r\n      var invalidFile = invalidFiles && invalidFiles.length ? invalidFiles[0] : null;\r\n\r\n      if (ngModel) {\r\n        upload.applyModelValidation(ngModel, files);\r\n        ngModel.$setViewValue(isSingleModel ? file : files);\r\n      }\r\n\r\n      if (fileChange) {\r\n        $parse(fileChange)(scope, {\r\n          $files: files,\r\n          $file: file,\r\n          $newFiles: newFiles,\r\n          $duplicateFiles: dupFiles,\r\n          $invalidFiles: invalidFiles,\r\n          $invalidFile: invalidFile,\r\n          $event: evt\r\n        });\r\n      }\r\n\r\n      var invalidModel = upload.attrGetter('ngfModelInvalid', attr);\r\n      if (invalidModel) {\r\n        $timeout(function () {\r\n          $parse(invalidModel).assign(scope, isSingleModel ? invalidFile : invalidFiles);\r\n        });\r\n      }\r\n      $timeout(function () {\r\n        // scope apply changes\r\n      });\r\n    }\r\n\r\n    var allNewFiles, dupFiles = [], prevValidFiles, prevInvalidFiles,\r\n      invalids = [], valids = [];\r\n\r\n    function removeDuplicates() {\r\n      function equals(f1, f2) {\r\n        return f1.name === f2.name && (f1.$ngfOrigSize || f1.size) === (f2.$ngfOrigSize || f2.size) &&\r\n          f1.type === f2.type;\r\n      }\r\n\r\n      function isInPrevFiles(f) {\r\n        var j;\r\n        for (j = 0; j < prevValidFiles.length; j++) {\r\n          if (equals(f, prevValidFiles[j])) {\r\n            return true;\r\n          }\r\n        }\r\n        for (j = 0; j < prevInvalidFiles.length; j++) {\r\n          if (equals(f, prevInvalidFiles[j])) {\r\n            return true;\r\n          }\r\n        }\r\n        return false;\r\n      }\r\n\r\n      if (files) {\r\n        allNewFiles = [];\r\n        dupFiles = [];\r\n        for (var i = 0; i < files.length; i++) {\r\n          if (isInPrevFiles(files[i])) {\r\n            dupFiles.push(files[i]);\r\n          } else {\r\n            allNewFiles.push(files[i]);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    function toArray(v) {\r\n      return angular.isArray(v) ? v : [v];\r\n    }\r\n\r\n    function resizeAndUpdate() {\r\n      function updateModel() {\r\n        $timeout(function () {\r\n          update(keep ? prevValidFiles.concat(valids) : valids,\r\n            keep ? prevInvalidFiles.concat(invalids) : invalids,\r\n            files, dupFiles, isSingleModel);\r\n        }, options && options.debounce ? options.debounce.change || options.debounce : 0);\r\n      }\r\n\r\n      var resizingFiles = validateAfterResize ? allNewFiles : valids;\r\n      resizeFile(resizingFiles, attr, scope, ngModel).then(function () {\r\n        if (validateAfterResize) {\r\n          upload.validate(allNewFiles, keep ? prevValidFiles.length : 0, ngModel, attr, scope)\r\n            .then(function (validationResult) {\r\n              valids = validationResult.validsFiles;\r\n              invalids = validationResult.invalidsFiles;\r\n              updateModel();\r\n            });\r\n        } else {\r\n          updateModel();\r\n        }\r\n      }, function () {\r\n        for (var i = 0; i < resizingFiles.length; i++) {\r\n          var f = resizingFiles[i];\r\n          if (f.$error === 'resize') {\r\n            var index = valids.indexOf(f);\r\n            if (index > -1) {\r\n              valids.splice(index, 1);\r\n              invalids.push(f);\r\n            }\r\n            updateModel();\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    prevValidFiles = attr.$$ngfPrevValidFiles || [];\r\n    prevInvalidFiles = attr.$$ngfPrevInvalidFiles || [];\r\n    if (ngModel && ngModel.$modelValue) {\r\n      prevValidFiles = toArray(ngModel.$modelValue);\r\n    }\r\n\r\n    var keep = upload.attrGetter('ngfKeep', attr, scope);\r\n    allNewFiles = (files || []).slice(0);\r\n    if (keep === 'distinct' || upload.attrGetter('ngfKeepDistinct', attr, scope) === true) {\r\n      removeDuplicates(attr, scope);\r\n    }\r\n\r\n    var isSingleModel = !keep && !upload.attrGetter('ngfMultiple', attr, scope) && !upload.attrGetter('multiple', attr);\r\n\r\n    if (keep && !allNewFiles.length) return;\r\n\r\n    upload.attrGetter('ngfBeforeModelChange', attr, scope, {\r\n      $files: files,\r\n      $file: files && files.length ? files[0] : null,\r\n      $newFiles: allNewFiles,\r\n      $duplicateFiles: dupFiles,\r\n      $event: evt\r\n    });\r\n\r\n    var validateAfterResize = upload.attrGetter('ngfValidateAfterResize', attr, scope);\r\n\r\n    var options = upload.attrGetter('ngfModelOptions', attr, scope);\r\n    upload.validate(allNewFiles, keep ? prevValidFiles.length : 0, ngModel, attr, scope)\r\n      .then(function (validationResult) {\r\n      if (noDelay) {\r\n        update(allNewFiles, [], files, dupFiles, isSingleModel);\r\n      } else {\r\n        if ((!options || !options.allowInvalid) && !validateAfterResize) {\r\n          valids = validationResult.validFiles;\r\n          invalids = validationResult.invalidFiles;\r\n        } else {\r\n          valids = allNewFiles;\r\n        }\r\n        if (upload.attrGetter('ngfFixOrientation', attr, scope) && upload.isExifSupported()) {\r\n          applyExifRotations(valids, attr, scope).then(function () {\r\n            resizeAndUpdate();\r\n          });\r\n        } else {\r\n          resizeAndUpdate();\r\n        }\r\n      }\r\n    });\r\n  };\r\n\r\n  return upload;\r\n}]);\r\n\r\nngFileUpload.directive('ngfSelect', ['$parse', '$timeout', '$compile', 'Upload', function ($parse, $timeout, $compile, Upload) {\r\n  var generatedElems = [];\r\n\r\n  function isDelayedClickSupported(ua) {\r\n    // fix for android native browser < 4.4 and safari windows\r\n    var m = ua.match(/Android[^\\d]*(\\d+)\\.(\\d+)/);\r\n    if (m && m.length > 2) {\r\n      var v = Upload.defaults.androidFixMinorVersion || 4;\r\n      return parseInt(m[1]) < 4 || (parseInt(m[1]) === v && parseInt(m[2]) < v);\r\n    }\r\n\r\n    // safari on windows\r\n    return ua.indexOf('Chrome') === -1 && /.*Windows.*Safari.*/.test(ua);\r\n  }\r\n\r\n  function linkFileSelect(scope, elem, attr, ngModel, $parse, $timeout, $compile, upload) {\r\n    /** @namespace attr.ngfSelect */\r\n    /** @namespace attr.ngfChange */\r\n    /** @namespace attr.ngModel */\r\n    /** @namespace attr.ngfModelOptions */\r\n    /** @namespace attr.ngfMultiple */\r\n    /** @namespace attr.ngfCapture */\r\n    /** @namespace attr.ngfValidate */\r\n    /** @namespace attr.ngfKeep */\r\n    var attrGetter = function (name, scope) {\r\n      return upload.attrGetter(name, attr, scope);\r\n    };\r\n\r\n    function isInputTypeFile() {\r\n      return elem[0].tagName.toLowerCase() === 'input' && attr.type && attr.type.toLowerCase() === 'file';\r\n    }\r\n\r\n    function fileChangeAttr() {\r\n      return attrGetter('ngfChange') || attrGetter('ngfSelect');\r\n    }\r\n\r\n    function changeFn(evt) {\r\n      if (upload.shouldUpdateOn('change', attr, scope)) {\r\n        var fileList = evt.__files_ || (evt.target && evt.target.files), files = [];\r\n        /* Handle duplicate call in  IE11 */\r\n        if (!fileList) return;\r\n        for (var i = 0; i < fileList.length; i++) {\r\n          files.push(fileList[i]);\r\n        }\r\n        upload.updateModel(ngModel, attr, scope, fileChangeAttr(),\r\n          files.length ? files : null, evt);\r\n      }\r\n    }\r\n\r\n    upload.registerModelChangeValidator(ngModel, attr, scope);\r\n\r\n    var unwatches = [];\r\n    if (attrGetter('ngfMultiple')) {\r\n      unwatches.push(scope.$watch(attrGetter('ngfMultiple'), function () {\r\n        fileElem.attr('multiple', attrGetter('ngfMultiple', scope));\r\n      }));\r\n    }\r\n    if (attrGetter('ngfCapture')) {\r\n      unwatches.push(scope.$watch(attrGetter('ngfCapture'), function () {\r\n        fileElem.attr('capture', attrGetter('ngfCapture', scope));\r\n      }));\r\n    }\r\n    if (attrGetter('ngfAccept')) {\r\n      unwatches.push(scope.$watch(attrGetter('ngfAccept'), function () {\r\n        fileElem.attr('accept', attrGetter('ngfAccept', scope));\r\n      }));\r\n    }\r\n    unwatches.push(attr.$observe('accept', function () {\r\n      fileElem.attr('accept', attrGetter('accept'));\r\n    }));\r\n    function bindAttrToFileInput(fileElem, label) {\r\n      function updateId(val) {\r\n        fileElem.attr('id', 'ngf-' + val);\r\n        label.attr('id', 'ngf-label-' + val);\r\n      }\r\n\r\n      for (var i = 0; i < elem[0].attributes.length; i++) {\r\n        var attribute = elem[0].attributes[i];\r\n        if (attribute.name !== 'type' && attribute.name !== 'class' && attribute.name !== 'style') {\r\n          if (attribute.name === 'id') {\r\n            updateId(attribute.value);\r\n            unwatches.push(attr.$observe('id', updateId));\r\n          } else {\r\n            fileElem.attr(attribute.name, (!attribute.value && (attribute.name === 'required' ||\r\n            attribute.name === 'multiple')) ? attribute.name : attribute.value);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    function createFileInput() {\r\n      if (isInputTypeFile()) {\r\n        return elem;\r\n      }\r\n\r\n      var fileElem = angular.element('<input type=\"file\">');\r\n\r\n      var label = angular.element('<label>upload</label>');\r\n      label.css('visibility', 'hidden').css('position', 'absolute').css('overflow', 'hidden')\r\n        .css('width', '0px').css('height', '0px').css('border', 'none')\r\n        .css('margin', '0px').css('padding', '0px').attr('tabindex', '-1');\r\n      bindAttrToFileInput(fileElem, label);\r\n\r\n      generatedElems.push({el: elem, ref: label});\r\n\r\n      document.body.appendChild(label.append(fileElem)[0]);\r\n\r\n      return fileElem;\r\n    }\r\n\r\n    function clickHandler(evt) {\r\n      if (elem.attr('disabled')) return false;\r\n      if (attrGetter('ngfSelectDisabled', scope)) return;\r\n\r\n      var r = detectSwipe(evt);\r\n      // prevent the click if it is a swipe\r\n      if (r != null) return r;\r\n\r\n      resetModel(evt);\r\n\r\n      // fix for md when the element is removed from the DOM and added back #460\r\n      try {\r\n        if (!isInputTypeFile() && !document.body.contains(fileElem[0])) {\r\n          generatedElems.push({el: elem, ref: fileElem.parent()});\r\n          document.body.appendChild(fileElem.parent()[0]);\r\n          fileElem.bind('change', changeFn);\r\n        }\r\n      } catch (e) {/*ignore*/\r\n      }\r\n\r\n      if (isDelayedClickSupported(navigator.userAgent)) {\r\n        setTimeout(function () {\r\n          fileElem[0].click();\r\n        }, 0);\r\n      } else {\r\n        fileElem[0].click();\r\n      }\r\n\r\n      return false;\r\n    }\r\n\r\n\r\n    var initialTouchStartY = 0;\r\n    var initialTouchStartX = 0;\r\n\r\n    function detectSwipe(evt) {\r\n      var touches = evt.changedTouches || (evt.originalEvent && evt.originalEvent.changedTouches);\r\n      if (touches) {\r\n        if (evt.type === 'touchstart') {\r\n          initialTouchStartX = touches[0].clientX;\r\n          initialTouchStartY = touches[0].clientY;\r\n          return true; // don't block event default\r\n        } else {\r\n          // prevent scroll from triggering event\r\n          if (evt.type === 'touchend') {\r\n            var currentX = touches[0].clientX;\r\n            var currentY = touches[0].clientY;\r\n            if ((Math.abs(currentX - initialTouchStartX) > 20) ||\r\n              (Math.abs(currentY - initialTouchStartY) > 20)) {\r\n              evt.stopPropagation();\r\n              evt.preventDefault();\r\n              return false;\r\n            }\r\n          }\r\n          return true;\r\n        }\r\n      }\r\n    }\r\n\r\n    var fileElem = elem;\r\n\r\n    function resetModel(evt) {\r\n      if (upload.shouldUpdateOn('click', attr, scope) && fileElem.val()) {\r\n        fileElem.val(null);\r\n        upload.updateModel(ngModel, attr, scope, fileChangeAttr(), null, evt, true);\r\n      }\r\n    }\r\n\r\n    if (!isInputTypeFile()) {\r\n      fileElem = createFileInput();\r\n    }\r\n    fileElem.bind('change', changeFn);\r\n\r\n    if (!isInputTypeFile()) {\r\n      elem.bind('click touchstart touchend', clickHandler);\r\n    } else {\r\n      elem.bind('click', resetModel);\r\n    }\r\n\r\n    function ie10SameFileSelectFix(evt) {\r\n      if (fileElem && !fileElem.attr('__ngf_ie10_Fix_')) {\r\n        if (!fileElem[0].parentNode) {\r\n          fileElem = null;\r\n          return;\r\n        }\r\n        evt.preventDefault();\r\n        evt.stopPropagation();\r\n        fileElem.unbind('click');\r\n        var clone = fileElem.clone();\r\n        fileElem.replaceWith(clone);\r\n        fileElem = clone;\r\n        fileElem.attr('__ngf_ie10_Fix_', 'true');\r\n        fileElem.bind('change', changeFn);\r\n        fileElem.bind('click', ie10SameFileSelectFix);\r\n        fileElem[0].click();\r\n        return false;\r\n      } else {\r\n        fileElem.removeAttr('__ngf_ie10_Fix_');\r\n      }\r\n    }\r\n\r\n    if (navigator.appVersion.indexOf('MSIE 10') !== -1) {\r\n      fileElem.bind('click', ie10SameFileSelectFix);\r\n    }\r\n\r\n    if (ngModel) ngModel.$formatters.push(function (val) {\r\n      if (val == null || val.length === 0) {\r\n        if (fileElem.val()) {\r\n          fileElem.val(null);\r\n        }\r\n      }\r\n      return val;\r\n    });\r\n\r\n    scope.$on('$destroy', function () {\r\n      if (!isInputTypeFile()) fileElem.parent().remove();\r\n      angular.forEach(unwatches, function (unwatch) {\r\n        unwatch();\r\n      });\r\n    });\r\n\r\n    $timeout(function () {\r\n      for (var i = 0; i < generatedElems.length; i++) {\r\n        var g = generatedElems[i];\r\n        if (!document.body.contains(g.el[0])) {\r\n          generatedElems.splice(i, 1);\r\n          g.ref.remove();\r\n        }\r\n      }\r\n    });\r\n\r\n    if (window.FileAPI && window.FileAPI.ngfFixIE) {\r\n      window.FileAPI.ngfFixIE(elem, fileElem, changeFn);\r\n    }\r\n  }\r\n\r\n  return {\r\n    restrict: 'AEC',\r\n    require: '?ngModel',\r\n    link: function (scope, elem, attr, ngModel) {\r\n      linkFileSelect(scope, elem, attr, ngModel, $parse, $timeout, $compile, Upload);\r\n    }\r\n  };\r\n}]);\r\n\r\n(function () {\r\n\r\n  ngFileUpload.service('UploadDataUrl', ['UploadBase', '$timeout', '$q', function (UploadBase, $timeout, $q) {\r\n    var upload = UploadBase;\r\n    upload.base64DataUrl = function (file) {\r\n      if (angular.isArray(file)) {\r\n        var d = $q.defer(), count = 0;\r\n        angular.forEach(file, function (f) {\r\n          upload.dataUrl(f, true)['finally'](function () {\r\n            count++;\r\n            if (count === file.length) {\r\n              var urls = [];\r\n              angular.forEach(file, function (ff) {\r\n                urls.push(ff.$ngfDataUrl);\r\n              });\r\n              d.resolve(urls, file);\r\n            }\r\n          });\r\n        });\r\n        return d.promise;\r\n      } else {\r\n        return upload.dataUrl(file, true);\r\n      }\r\n    };\r\n    upload.dataUrl = function (file, disallowObjectUrl) {\r\n      if (!file) return upload.emptyPromise(file, file);\r\n      if ((disallowObjectUrl && file.$ngfDataUrl != null) || (!disallowObjectUrl && file.$ngfBlobUrl != null)) {\r\n        return upload.emptyPromise(disallowObjectUrl ? file.$ngfDataUrl : file.$ngfBlobUrl, file);\r\n      }\r\n      var p = disallowObjectUrl ? file.$$ngfDataUrlPromise : file.$$ngfBlobUrlPromise;\r\n      if (p) return p;\r\n\r\n      var deferred = $q.defer();\r\n      $timeout(function () {\r\n        if (window.FileReader && file &&\r\n          (!window.FileAPI || navigator.userAgent.indexOf('MSIE 8') === -1 || file.size < 20000) &&\r\n          (!window.FileAPI || navigator.userAgent.indexOf('MSIE 9') === -1 || file.size < 4000000)) {\r\n          //prefer URL.createObjectURL for handling refrences to files of all sizes\r\n          //since it doesn´t build a large string in memory\r\n          var URL = window.URL || window.webkitURL;\r\n          if (URL && URL.createObjectURL && !disallowObjectUrl) {\r\n            var url;\r\n            try {\r\n              url = URL.createObjectURL(file);\r\n            } catch (e) {\r\n              $timeout(function () {\r\n                file.$ngfBlobUrl = '';\r\n                deferred.reject();\r\n              });\r\n              return;\r\n            }\r\n            $timeout(function () {\r\n              file.$ngfBlobUrl = url;\r\n              if (url) {\r\n                deferred.resolve(url, file);\r\n                upload.blobUrls = upload.blobUrls || [];\r\n                upload.blobUrlsTotalSize = upload.blobUrlsTotalSize || 0;\r\n                upload.blobUrls.push({url: url, size: file.size});\r\n                upload.blobUrlsTotalSize += file.size || 0;\r\n                var maxMemory = upload.defaults.blobUrlsMaxMemory || 268435456;\r\n                var maxLength = upload.defaults.blobUrlsMaxQueueSize || 200;\r\n                while ((upload.blobUrlsTotalSize > maxMemory || upload.blobUrls.length > maxLength) && upload.blobUrls.length > 1) {\r\n                  var obj = upload.blobUrls.splice(0, 1)[0];\r\n                  URL.revokeObjectURL(obj.url);\r\n                  upload.blobUrlsTotalSize -= obj.size;\r\n                }\r\n              }\r\n            });\r\n          } else {\r\n            var fileReader = new FileReader();\r\n            fileReader.onload = function (e) {\r\n              $timeout(function () {\r\n                file.$ngfDataUrl = e.target.result;\r\n                deferred.resolve(e.target.result, file);\r\n                $timeout(function () {\r\n                  delete file.$ngfDataUrl;\r\n                }, 1000);\r\n              });\r\n            };\r\n            fileReader.onerror = function () {\r\n              $timeout(function () {\r\n                file.$ngfDataUrl = '';\r\n                deferred.reject();\r\n              });\r\n            };\r\n            fileReader.readAsDataURL(file);\r\n          }\r\n        } else {\r\n          $timeout(function () {\r\n            file[disallowObjectUrl ? '$ngfDataUrl' : '$ngfBlobUrl'] = '';\r\n            deferred.reject();\r\n          });\r\n        }\r\n      });\r\n\r\n      if (disallowObjectUrl) {\r\n        p = file.$$ngfDataUrlPromise = deferred.promise;\r\n      } else {\r\n        p = file.$$ngfBlobUrlPromise = deferred.promise;\r\n      }\r\n      p['finally'](function () {\r\n        delete file[disallowObjectUrl ? '$$ngfDataUrlPromise' : '$$ngfBlobUrlPromise'];\r\n      });\r\n      return p;\r\n    };\r\n    return upload;\r\n  }]);\r\n\r\n  function getTagType(el) {\r\n    if (el.tagName.toLowerCase() === 'img') return 'image';\r\n    if (el.tagName.toLowerCase() === 'audio') return 'audio';\r\n    if (el.tagName.toLowerCase() === 'video') return 'video';\r\n    return /./;\r\n  }\r\n\r\n  function linkFileDirective(Upload, $timeout, scope, elem, attr, directiveName, resizeParams, isBackground) {\r\n    function constructDataUrl(file) {\r\n      var disallowObjectUrl = Upload.attrGetter('ngfNoObjectUrl', attr, scope);\r\n      Upload.dataUrl(file, disallowObjectUrl)['finally'](function () {\r\n        $timeout(function () {\r\n          var src = (disallowObjectUrl ? file.$ngfDataUrl : file.$ngfBlobUrl) || file.$ngfDataUrl;\r\n          if (isBackground) {\r\n            elem.css('background-image', 'url(\\'' + (src || '') + '\\')');\r\n          } else {\r\n            elem.attr('src', src);\r\n          }\r\n          if (src) {\r\n            elem.removeClass('ng-hide');\r\n          } else {\r\n            elem.addClass('ng-hide');\r\n          }\r\n        });\r\n      });\r\n    }\r\n\r\n    $timeout(function () {\r\n      var unwatch = scope.$watch(attr[directiveName], function (file) {\r\n        var size = resizeParams;\r\n        if (directiveName === 'ngfThumbnail') {\r\n          if (!size) {\r\n            size = {\r\n              width: elem[0].naturalWidth || elem[0].clientWidth,\r\n              height: elem[0].naturalHeight || elem[0].clientHeight\r\n            };\r\n          }\r\n          if (size.width === 0 && window.getComputedStyle) {\r\n            var style = getComputedStyle(elem[0]);\r\n            if (style.width && style.width.indexOf('px') > -1 && style.height && style.height.indexOf('px') > -1) {\r\n              size = {\r\n                width: parseInt(style.width.slice(0, -2)),\r\n                height: parseInt(style.height.slice(0, -2))\r\n              };\r\n            }\r\n          }\r\n        }\r\n\r\n        if (angular.isString(file)) {\r\n          elem.removeClass('ng-hide');\r\n          if (isBackground) {\r\n            return elem.css('background-image', 'url(\\'' + file + '\\')');\r\n          } else {\r\n            return elem.attr('src', file);\r\n          }\r\n        }\r\n        if (file && file.type && file.type.search(getTagType(elem[0])) === 0 &&\r\n          (!isBackground || file.type.indexOf('image') === 0)) {\r\n          if (size && Upload.isResizeSupported()) {\r\n            size.resizeIf = function (width, height) {\r\n              return Upload.attrGetter('ngfResizeIf', attr, scope,\r\n                {$width: width, $height: height, $file: file});\r\n            };\r\n            Upload.resize(file, size).then(\r\n              function (f) {\r\n                constructDataUrl(f);\r\n              }, function (e) {\r\n                throw e;\r\n              }\r\n            );\r\n          } else {\r\n            constructDataUrl(file);\r\n          }\r\n        } else {\r\n          elem.addClass('ng-hide');\r\n        }\r\n      });\r\n\r\n      scope.$on('$destroy', function () {\r\n        unwatch();\r\n      });\r\n    });\r\n  }\r\n\r\n\r\n  /** @namespace attr.ngfSrc */\r\n  /** @namespace attr.ngfNoObjectUrl */\r\n  ngFileUpload.directive('ngfSrc', ['Upload', '$timeout', function (Upload, $timeout) {\r\n    return {\r\n      restrict: 'AE',\r\n      link: function (scope, elem, attr) {\r\n        linkFileDirective(Upload, $timeout, scope, elem, attr, 'ngfSrc',\r\n          Upload.attrGetter('ngfResize', attr, scope), false);\r\n      }\r\n    };\r\n  }]);\r\n\r\n  /** @namespace attr.ngfBackground */\r\n  /** @namespace attr.ngfNoObjectUrl */\r\n  ngFileUpload.directive('ngfBackground', ['Upload', '$timeout', function (Upload, $timeout) {\r\n    return {\r\n      restrict: 'AE',\r\n      link: function (scope, elem, attr) {\r\n        linkFileDirective(Upload, $timeout, scope, elem, attr, 'ngfBackground',\r\n          Upload.attrGetter('ngfResize', attr, scope), true);\r\n      }\r\n    };\r\n  }]);\r\n\r\n  /** @namespace attr.ngfThumbnail */\r\n  /** @namespace attr.ngfAsBackground */\r\n  /** @namespace attr.ngfSize */\r\n  /** @namespace attr.ngfNoObjectUrl */\r\n  ngFileUpload.directive('ngfThumbnail', ['Upload', '$timeout', function (Upload, $timeout) {\r\n    return {\r\n      restrict: 'AE',\r\n      link: function (scope, elem, attr) {\r\n        var size = Upload.attrGetter('ngfSize', attr, scope);\r\n        linkFileDirective(Upload, $timeout, scope, elem, attr, 'ngfThumbnail', size,\r\n          Upload.attrGetter('ngfAsBackground', attr, scope));\r\n      }\r\n    };\r\n  }]);\r\n\r\n  ngFileUpload.config(['$compileProvider', function ($compileProvider) {\r\n    if ($compileProvider.imgSrcSanitizationWhitelist) $compileProvider.imgSrcSanitizationWhitelist(/^\\s*(https?|ftp|mailto|tel|webcal|local|file|data|blob):/);\r\n    if ($compileProvider.aHrefSanitizationWhitelist) $compileProvider.aHrefSanitizationWhitelist(/^\\s*(https?|ftp|mailto|tel|webcal|local|file|data|blob):/);\r\n  }]);\r\n\r\n  ngFileUpload.filter('ngfDataUrl', ['UploadDataUrl', '$sce', function (UploadDataUrl, $sce) {\r\n    return function (file, disallowObjectUrl, trustedUrl) {\r\n      if (angular.isString(file)) {\r\n        return $sce.trustAsResourceUrl(file);\r\n      }\r\n      var src = file && ((disallowObjectUrl ? file.$ngfDataUrl : file.$ngfBlobUrl) || file.$ngfDataUrl);\r\n      if (file && !src) {\r\n        if (!file.$ngfDataUrlFilterInProgress && angular.isObject(file)) {\r\n          file.$ngfDataUrlFilterInProgress = true;\r\n          UploadDataUrl.dataUrl(file, disallowObjectUrl);\r\n        }\r\n        return '';\r\n      }\r\n      if (file) delete file.$ngfDataUrlFilterInProgress;\r\n      return (file && src ? (trustedUrl ? $sce.trustAsResourceUrl(src) : src) : file) || '';\r\n    };\r\n  }]);\r\n\r\n})();\r\n\r\nngFileUpload.service('UploadValidate', ['UploadDataUrl', '$q', '$timeout', function (UploadDataUrl, $q, $timeout) {\r\n  var upload = UploadDataUrl;\r\n\r\n  function globStringToRegex(str) {\r\n    var regexp = '', excludes = [];\r\n    if (str.length > 2 && str[0] === '/' && str[str.length - 1] === '/') {\r\n      regexp = str.substring(1, str.length - 1);\r\n    } else {\r\n      var split = str.split(',');\r\n      if (split.length > 1) {\r\n        for (var i = 0; i < split.length; i++) {\r\n          var r = globStringToRegex(split[i]);\r\n          if (r.regexp) {\r\n            regexp += '(' + r.regexp + ')';\r\n            if (i < split.length - 1) {\r\n              regexp += '|';\r\n            }\r\n          } else {\r\n            excludes = excludes.concat(r.excludes);\r\n          }\r\n        }\r\n      } else {\r\n        if (str.indexOf('!') === 0) {\r\n          excludes.push('^((?!' + globStringToRegex(str.substring(1)).regexp + ').)*$');\r\n        } else {\r\n          if (str.indexOf('.') === 0) {\r\n            str = '*' + str;\r\n          }\r\n          regexp = '^' + str.replace(new RegExp('[.\\\\\\\\+*?\\\\[\\\\^\\\\]$(){}=!<>|:\\\\-]', 'g'), '\\\\$&') + '$';\r\n          regexp = regexp.replace(/\\\\\\*/g, '.*').replace(/\\\\\\?/g, '.');\r\n        }\r\n      }\r\n    }\r\n    return {regexp: regexp, excludes: excludes};\r\n  }\r\n\r\n  upload.validatePattern = function (file, val) {\r\n    if (!val) {\r\n      return true;\r\n    }\r\n    var pattern = globStringToRegex(val), valid = true;\r\n    if (pattern.regexp && pattern.regexp.length) {\r\n      var regexp = new RegExp(pattern.regexp, 'i');\r\n      valid = (file.type != null && regexp.test(file.type)) ||\r\n        (file.name != null && regexp.test(file.name));\r\n    }\r\n    var len = pattern.excludes.length;\r\n    while (len--) {\r\n      var exclude = new RegExp(pattern.excludes[len], 'i');\r\n      valid = valid && (file.type == null || exclude.test(file.type)) &&\r\n        (file.name == null || exclude.test(file.name));\r\n    }\r\n    return valid;\r\n  };\r\n\r\n  upload.ratioToFloat = function (val) {\r\n    var r = val.toString(), xIndex = r.search(/[x:]/i);\r\n    if (xIndex > -1) {\r\n      r = parseFloat(r.substring(0, xIndex)) / parseFloat(r.substring(xIndex + 1));\r\n    } else {\r\n      r = parseFloat(r);\r\n    }\r\n    return r;\r\n  };\r\n\r\n  upload.registerModelChangeValidator = function (ngModel, attr, scope) {\r\n    if (ngModel) {\r\n      ngModel.$formatters.push(function (files) {\r\n        if (ngModel.$dirty) {\r\n          var filesArray = files;\r\n          if (files && !angular.isArray(files)) {\r\n            filesArray = [files];\r\n          }\r\n          upload.validate(filesArray, 0, ngModel, attr, scope).then(function () {\r\n            upload.applyModelValidation(ngModel, filesArray);\r\n          });\r\n        }\r\n        return files;\r\n      });\r\n    }\r\n  };\r\n\r\n  function markModelAsDirty(ngModel, files) {\r\n    if (files != null && !ngModel.$dirty) {\r\n      if (ngModel.$setDirty) {\r\n        ngModel.$setDirty();\r\n      } else {\r\n        ngModel.$dirty = true;\r\n      }\r\n    }\r\n  }\r\n\r\n  upload.applyModelValidation = function (ngModel, files) {\r\n    markModelAsDirty(ngModel, files);\r\n    angular.forEach(ngModel.$ngfValidations, function (validation) {\r\n      ngModel.$setValidity(validation.name, validation.valid);\r\n    });\r\n  };\r\n\r\n  upload.getValidationAttr = function (attr, scope, name, validationName, file) {\r\n    var dName = 'ngf' + name[0].toUpperCase() + name.substr(1);\r\n    var val = upload.attrGetter(dName, attr, scope, {$file: file});\r\n    if (val == null) {\r\n      val = upload.attrGetter('ngfValidate', attr, scope, {$file: file});\r\n      if (val) {\r\n        var split = (validationName || name).split('.');\r\n        val = val[split[0]];\r\n        if (split.length > 1) {\r\n          val = val && val[split[1]];\r\n        }\r\n      }\r\n    }\r\n    return val;\r\n  };\r\n\r\n  upload.validate = function (files, prevLength, ngModel, attr, scope) {\r\n    ngModel = ngModel || {};\r\n    ngModel.$ngfValidations = ngModel.$ngfValidations || [];\r\n\r\n    angular.forEach(ngModel.$ngfValidations, function (v) {\r\n      v.valid = true;\r\n    });\r\n\r\n    var attrGetter = function (name, params) {\r\n      return upload.attrGetter(name, attr, scope, params);\r\n    };\r\n\r\n    var ignoredErrors = (upload.attrGetter('ngfIgnoreInvalid', attr, scope) || '').split(' ');\r\n    var runAllValidation = upload.attrGetter('ngfRunAllValidations', attr, scope);\r\n\r\n    if (files == null || files.length === 0) {\r\n      return upload.emptyPromise({'validFiles': files, 'invalidFiles': []});\r\n    }\r\n\r\n    files = files.length === undefined ? [files] : files.slice(0);\r\n    var invalidFiles = [];\r\n\r\n    function validateSync(name, validationName, fn) {\r\n      if (files) {\r\n        var i = files.length, valid = null;\r\n        while (i--) {\r\n          var file = files[i];\r\n          if (file) {\r\n            var val = upload.getValidationAttr(attr, scope, name, validationName, file);\r\n            if (val != null) {\r\n              if (!fn(file, val, i)) {\r\n                if (ignoredErrors.indexOf(name) === -1) {\r\n                  file.$error = name;\r\n                  (file.$errorMessages = (file.$errorMessages || {}))[name] = true;\r\n                  file.$errorParam = val;\r\n                  if (invalidFiles.indexOf(file) === -1) {\r\n                    invalidFiles.push(file);\r\n                  }\r\n                  if (!runAllValidation) {\r\n                    files.splice(i, 1);\r\n                  }\r\n                  valid = false;\r\n                } else {\r\n                  files.splice(i, 1);\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n        if (valid !== null) {\r\n          ngModel.$ngfValidations.push({name: name, valid: valid});\r\n        }\r\n      }\r\n    }\r\n\r\n    validateSync('pattern', null, upload.validatePattern);\r\n    validateSync('minSize', 'size.min', function (file, val) {\r\n      return file.size + 0.1 >= upload.translateScalars(val);\r\n    });\r\n    validateSync('maxSize', 'size.max', function (file, val) {\r\n      return file.size - 0.1 <= upload.translateScalars(val);\r\n    });\r\n    var totalSize = 0;\r\n    validateSync('maxTotalSize', null, function (file, val) {\r\n      totalSize += file.size;\r\n      if (totalSize > upload.translateScalars(val)) {\r\n        files.splice(0, files.length);\r\n        return false;\r\n      }\r\n      return true;\r\n    });\r\n\r\n    validateSync('validateFn', null, function (file, r) {\r\n      return r === true || r === null || r === '';\r\n    });\r\n\r\n    if (!files.length) {\r\n      return upload.emptyPromise({'validFiles': [], 'invalidFiles': invalidFiles});\r\n    }\r\n\r\n    function validateAsync(name, validationName, type, asyncFn, fn) {\r\n      function resolveResult(defer, file, val) {\r\n        function resolveInternal(fn) {\r\n          if (fn()) {\r\n            if (ignoredErrors.indexOf(name) === -1) {\r\n              file.$error = name;\r\n              (file.$errorMessages = (file.$errorMessages || {}))[name] = true;\r\n              file.$errorParam = val;\r\n              if (invalidFiles.indexOf(file) === -1) {\r\n                invalidFiles.push(file);\r\n              }\r\n              if (!runAllValidation) {\r\n                var i = files.indexOf(file);\r\n                if (i > -1) files.splice(i, 1);\r\n              }\r\n              defer.resolve(false);\r\n            } else {\r\n              var j = files.indexOf(file);\r\n              if (j > -1) files.splice(j, 1);\r\n              defer.resolve(true);\r\n            }\r\n          } else {\r\n            defer.resolve(true);\r\n          }\r\n        }\r\n\r\n        if (val != null) {\r\n          asyncFn(file, val).then(function (d) {\r\n            resolveInternal(function () {\r\n              return !fn(d, val);\r\n            });\r\n          }, function () {\r\n            resolveInternal(function () {\r\n              return attrGetter('ngfValidateForce', {$file: file});\r\n            });\r\n          });\r\n        } else {\r\n          defer.resolve(true);\r\n        }\r\n      }\r\n\r\n      var promises = [upload.emptyPromise(true)];\r\n      if (files) {\r\n        files = files.length === undefined ? [files] : files;\r\n        angular.forEach(files, function (file) {\r\n          var defer = $q.defer();\r\n          promises.push(defer.promise);\r\n          if (type && (file.type == null || file.type.search(type) !== 0)) {\r\n            defer.resolve(true);\r\n            return;\r\n          }\r\n          if (name === 'dimensions' && upload.attrGetter('ngfDimensions', attr) != null) {\r\n            upload.imageDimensions(file).then(function (d) {\r\n              resolveResult(defer, file,\r\n                attrGetter('ngfDimensions', {$file: file, $width: d.width, $height: d.height}));\r\n            }, function () {\r\n              defer.resolve(false);\r\n            });\r\n          } else if (name === 'duration' && upload.attrGetter('ngfDuration', attr) != null) {\r\n            upload.mediaDuration(file).then(function (d) {\r\n              resolveResult(defer, file,\r\n                attrGetter('ngfDuration', {$file: file, $duration: d}));\r\n            }, function () {\r\n              defer.resolve(false);\r\n            });\r\n          } else {\r\n            resolveResult(defer, file,\r\n              upload.getValidationAttr(attr, scope, name, validationName, file));\r\n          }\r\n        });\r\n      }\r\n      var deffer = $q.defer();\r\n      $q.all(promises).then(function (values) {\r\n        var isValid = true;\r\n        for (var i = 0; i < values.length; i++) {\r\n          if (!values[i]) {\r\n            isValid = false;\r\n            break;\r\n          }\r\n        }\r\n        ngModel.$ngfValidations.push({name: name, valid: isValid});\r\n        deffer.resolve(isValid);\r\n      });\r\n      return deffer.promise;\r\n    }\r\n\r\n    var deffer = $q.defer();\r\n    var promises = [];\r\n\r\n    promises.push(validateAsync('maxHeight', 'height.max', /image/,\r\n      this.imageDimensions, function (d, val) {\r\n        return d.height <= val;\r\n      }));\r\n    promises.push(validateAsync('minHeight', 'height.min', /image/,\r\n      this.imageDimensions, function (d, val) {\r\n        return d.height >= val;\r\n      }));\r\n    promises.push(validateAsync('maxWidth', 'width.max', /image/,\r\n      this.imageDimensions, function (d, val) {\r\n        return d.width <= val;\r\n      }));\r\n    promises.push(validateAsync('minWidth', 'width.min', /image/,\r\n      this.imageDimensions, function (d, val) {\r\n        return d.width >= val;\r\n      }));\r\n    promises.push(validateAsync('dimensions', null, /image/,\r\n      function (file, val) {\r\n        return upload.emptyPromise(val);\r\n      }, function (r) {\r\n        return r;\r\n      }));\r\n    promises.push(validateAsync('ratio', null, /image/,\r\n      this.imageDimensions, function (d, val) {\r\n        var split = val.toString().split(','), valid = false;\r\n        for (var i = 0; i < split.length; i++) {\r\n          if (Math.abs((d.width / d.height) - upload.ratioToFloat(split[i])) < 0.01) {\r\n            valid = true;\r\n          }\r\n        }\r\n        return valid;\r\n      }));\r\n    promises.push(validateAsync('maxRatio', 'ratio.max', /image/,\r\n      this.imageDimensions, function (d, val) {\r\n        return (d.width / d.height) - upload.ratioToFloat(val) < 0.0001;\r\n      }));\r\n    promises.push(validateAsync('minRatio', 'ratio.min', /image/,\r\n      this.imageDimensions, function (d, val) {\r\n        return (d.width / d.height) - upload.ratioToFloat(val) > -0.0001;\r\n      }));\r\n    promises.push(validateAsync('maxDuration', 'duration.max', /audio|video/,\r\n      this.mediaDuration, function (d, val) {\r\n        return d <= upload.translateScalars(val);\r\n      }));\r\n    promises.push(validateAsync('minDuration', 'duration.min', /audio|video/,\r\n      this.mediaDuration, function (d, val) {\r\n        return d >= upload.translateScalars(val);\r\n      }));\r\n    promises.push(validateAsync('duration', null, /audio|video/,\r\n      function (file, val) {\r\n        return upload.emptyPromise(val);\r\n      }, function (r) {\r\n        return r;\r\n      }));\r\n\r\n    promises.push(validateAsync('validateAsyncFn', null, null,\r\n      function (file, val) {\r\n        return val;\r\n      }, function (r) {\r\n        return r === true || r === null || r === '';\r\n      }));\r\n\r\n    $q.all(promises).then(function () {\r\n\r\n      if (runAllValidation) {\r\n        for (var i = 0; i < files.length; i++) {\r\n          var file = files[i];\r\n          if (file.$error) {\r\n            files.splice(i--, 1);\r\n          }\r\n        }\r\n      }\r\n\r\n      runAllValidation = false;\r\n      validateSync('maxFiles', null, function (file, val, i) {\r\n        return prevLength + i < val;\r\n      });\r\n\r\n      deffer.resolve({'validFiles': files, 'invalidFiles': invalidFiles});\r\n    });\r\n    return deffer.promise;\r\n  };\r\n\r\n  upload.imageDimensions = function (file) {\r\n    if (file.$ngfWidth && file.$ngfHeight) {\r\n      var d = $q.defer();\r\n      $timeout(function () {\r\n        d.resolve({width: file.$ngfWidth, height: file.$ngfHeight});\r\n      });\r\n      return d.promise;\r\n    }\r\n    if (file.$ngfDimensionPromise) return file.$ngfDimensionPromise;\r\n\r\n    var deferred = $q.defer();\r\n    $timeout(function () {\r\n      if (file.type.indexOf('image') !== 0) {\r\n        deferred.reject('not image');\r\n        return;\r\n      }\r\n      upload.dataUrl(file).then(function (dataUrl) {\r\n        var img = angular.element('<img>').attr('src', dataUrl)\r\n          .css('visibility', 'hidden').css('position', 'fixed')\r\n          .css('max-width', 'none !important').css('max-height', 'none !important');\r\n\r\n        function success() {\r\n          var width = img[0].naturalWidth || img[0].clientWidth;\r\n          var height = img[0].naturalHeight || img[0].clientHeight;\r\n          img.remove();\r\n          file.$ngfWidth = width;\r\n          file.$ngfHeight = height;\r\n          deferred.resolve({width: width, height: height});\r\n        }\r\n\r\n        function error() {\r\n          img.remove();\r\n          deferred.reject('load error');\r\n        }\r\n\r\n        img.on('load', success);\r\n        img.on('error', error);\r\n\r\n        var secondsCounter = 0;\r\n        function checkLoadErrorInCaseOfNoCallback() {\r\n          $timeout(function () {\r\n            if (img[0].parentNode) {\r\n              if (img[0].clientWidth) {\r\n                success();\r\n              } else if (secondsCounter++ > 10) {\r\n                error();\r\n              } else {\r\n                checkLoadErrorInCaseOfNoCallback();\r\n              }\r\n            }\r\n          }, 1000);\r\n        }\r\n\r\n        checkLoadErrorInCaseOfNoCallback();\r\n\r\n        angular.element(document.getElementsByTagName('body')[0]).append(img);\r\n      }, function () {\r\n        deferred.reject('load error');\r\n      });\r\n    });\r\n\r\n    file.$ngfDimensionPromise = deferred.promise;\r\n    file.$ngfDimensionPromise['finally'](function () {\r\n      delete file.$ngfDimensionPromise;\r\n    });\r\n    return file.$ngfDimensionPromise;\r\n  };\r\n\r\n  upload.mediaDuration = function (file) {\r\n    if (file.$ngfDuration) {\r\n      var d = $q.defer();\r\n      $timeout(function () {\r\n        d.resolve(file.$ngfDuration);\r\n      });\r\n      return d.promise;\r\n    }\r\n    if (file.$ngfDurationPromise) return file.$ngfDurationPromise;\r\n\r\n    var deferred = $q.defer();\r\n    $timeout(function () {\r\n      if (file.type.indexOf('audio') !== 0 && file.type.indexOf('video') !== 0) {\r\n        deferred.reject('not media');\r\n        return;\r\n      }\r\n      upload.dataUrl(file).then(function (dataUrl) {\r\n        var el = angular.element(file.type.indexOf('audio') === 0 ? '<audio>' : '<video>')\r\n          .attr('src', dataUrl).css('visibility', 'none').css('position', 'fixed');\r\n\r\n        function success() {\r\n          var duration = el[0].duration;\r\n          file.$ngfDuration = duration;\r\n          el.remove();\r\n          deferred.resolve(duration);\r\n        }\r\n\r\n        function error() {\r\n          el.remove();\r\n          deferred.reject('load error');\r\n        }\r\n\r\n        el.on('loadedmetadata', success);\r\n        el.on('error', error);\r\n        var count = 0;\r\n\r\n        function checkLoadError() {\r\n          $timeout(function () {\r\n            if (el[0].parentNode) {\r\n              if (el[0].duration) {\r\n                success();\r\n              } else if (count > 10) {\r\n                error();\r\n              } else {\r\n                checkLoadError();\r\n              }\r\n            }\r\n          }, 1000);\r\n        }\r\n\r\n        checkLoadError();\r\n\r\n        angular.element(document.body).append(el);\r\n      }, function () {\r\n        deferred.reject('load error');\r\n      });\r\n    });\r\n\r\n    file.$ngfDurationPromise = deferred.promise;\r\n    file.$ngfDurationPromise['finally'](function () {\r\n      delete file.$ngfDurationPromise;\r\n    });\r\n    return file.$ngfDurationPromise;\r\n  };\r\n  return upload;\r\n}\r\n]);\r\n\r\nngFileUpload.service('UploadResize', ['UploadValidate', '$q', function (UploadValidate, $q) {\r\n  var upload = UploadValidate;\r\n\r\n  /**\r\n   * Conserve aspect ratio of the original region. Useful when shrinking/enlarging\r\n   * images to fit into a certain area.\r\n   * Source:  http://stackoverflow.com/a/14731922\r\n   *\r\n   * @param {Number} srcWidth Source area width\r\n   * @param {Number} srcHeight Source area height\r\n   * @param {Number} maxWidth Nestable area maximum available width\r\n   * @param {Number} maxHeight Nestable area maximum available height\r\n   * @return {Object} { width, height }\r\n   */\r\n  var calculateAspectRatioFit = function (srcWidth, srcHeight, maxWidth, maxHeight, centerCrop) {\r\n    var ratio = centerCrop ? Math.max(maxWidth / srcWidth, maxHeight / srcHeight) :\r\n      Math.min(maxWidth / srcWidth, maxHeight / srcHeight);\r\n    return {\r\n      width: srcWidth * ratio, height: srcHeight * ratio,\r\n      marginX: srcWidth * ratio - maxWidth, marginY: srcHeight * ratio - maxHeight\r\n    };\r\n  };\r\n\r\n  // Extracted from https://github.com/romelgomez/angular-firebase-image-upload/blob/master/app/scripts/fileUpload.js#L89\r\n  var resize = function (imagen, width, height, quality, type, ratio, centerCrop, resizeIf) {\r\n    var deferred = $q.defer();\r\n    var canvasElement = document.createElement('canvas');\r\n    var imageElement = document.createElement('img');\r\n    imageElement.setAttribute('style', 'visibility:hidden;position:fixed;z-index:-100000');\r\n    document.body.appendChild(imageElement);\r\n\r\n    imageElement.onload = function () {\r\n      var imgWidth = imageElement.width, imgHeight = imageElement.height;\r\n      imageElement.parentNode.removeChild(imageElement);\r\n      if (resizeIf != null && resizeIf(imgWidth, imgHeight) === false) {\r\n        deferred.reject('resizeIf');\r\n        return;\r\n      }\r\n      try {\r\n        if (ratio) {\r\n          var ratioFloat = upload.ratioToFloat(ratio);\r\n          var imgRatio = imgWidth / imgHeight;\r\n          if (imgRatio < ratioFloat) {\r\n            width = imgWidth;\r\n            height = width / ratioFloat;\r\n          } else {\r\n            height = imgHeight;\r\n            width = height * ratioFloat;\r\n          }\r\n        }\r\n        if (!width) {\r\n          width = imgWidth;\r\n        }\r\n        if (!height) {\r\n          height = imgHeight;\r\n        }\r\n        var dimensions = calculateAspectRatioFit(imgWidth, imgHeight, width, height, centerCrop);\r\n        canvasElement.width = Math.min(dimensions.width, width);\r\n        canvasElement.height = Math.min(dimensions.height, height);\r\n        var context = canvasElement.getContext('2d');\r\n        context.drawImage(imageElement,\r\n          Math.min(0, -dimensions.marginX / 2), Math.min(0, -dimensions.marginY / 2),\r\n          dimensions.width, dimensions.height);\r\n        deferred.resolve(canvasElement.toDataURL(type || 'image/WebP', quality || 0.934));\r\n      } catch (e) {\r\n        deferred.reject(e);\r\n      }\r\n    };\r\n    imageElement.onerror = function () {\r\n      imageElement.parentNode.removeChild(imageElement);\r\n      deferred.reject();\r\n    };\r\n    imageElement.src = imagen;\r\n    return deferred.promise;\r\n  };\r\n\r\n  upload.dataUrltoBlob = function (dataurl, name, origSize) {\r\n    var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],\r\n      bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);\r\n    while (n--) {\r\n      u8arr[n] = bstr.charCodeAt(n);\r\n    }\r\n    var blob = new window.Blob([u8arr], {type: mime});\r\n    blob.name = name;\r\n    blob.$ngfOrigSize = origSize;\r\n    return blob;\r\n  };\r\n\r\n  upload.isResizeSupported = function () {\r\n    var elem = document.createElement('canvas');\r\n    return window.atob && elem.getContext && elem.getContext('2d') && window.Blob;\r\n  };\r\n\r\n  if (upload.isResizeSupported()) {\r\n    // add name getter to the blob constructor prototype\r\n    Object.defineProperty(window.Blob.prototype, 'name', {\r\n      get: function () {\r\n        return this.$ngfName;\r\n      },\r\n      set: function (v) {\r\n        this.$ngfName = v;\r\n      },\r\n      configurable: true\r\n    });\r\n  }\r\n\r\n  upload.resize = function (file, options) {\r\n    if (file.type.indexOf('image') !== 0) return upload.emptyPromise(file);\r\n\r\n    var deferred = $q.defer();\r\n    upload.dataUrl(file, true).then(function (url) {\r\n      resize(url, options.width, options.height, options.quality, options.type || file.type,\r\n        options.ratio, options.centerCrop, options.resizeIf)\r\n        .then(function (dataUrl) {\r\n          if (file.type === 'image/jpeg' && options.restoreExif !== false) {\r\n            try {\r\n              dataUrl = upload.restoreExif(url, dataUrl);\r\n            } catch (e) {\r\n              setTimeout(function () {throw e;}, 1);\r\n            }\r\n          }\r\n          try {\r\n            var blob = upload.dataUrltoBlob(dataUrl, file.name, file.size);\r\n            deferred.resolve(blob);\r\n          } catch (e) {\r\n            deferred.reject(e);\r\n          }\r\n        }, function (r) {\r\n          if (r === 'resizeIf') {\r\n            deferred.resolve(file);\r\n          }\r\n          deferred.reject(r);\r\n        });\r\n    }, function (e) {\r\n      deferred.reject(e);\r\n    });\r\n    return deferred.promise;\r\n  };\r\n\r\n  return upload;\r\n}]);\r\n\r\n(function () {\r\n  ngFileUpload.directive('ngfDrop', ['$parse', '$timeout', '$window', 'Upload', '$http', '$q',\r\n    function ($parse, $timeout, $window, Upload, $http, $q) {\r\n      return {\r\n        restrict: 'AEC',\r\n        require: '?ngModel',\r\n        link: function (scope, elem, attr, ngModel) {\r\n          linkDrop(scope, elem, attr, ngModel, $parse, $timeout, $window, Upload, $http, $q);\r\n        }\r\n      };\r\n    }]);\r\n\r\n  ngFileUpload.directive('ngfNoFileDrop', function () {\r\n    return function (scope, elem) {\r\n      if (dropAvailable()) elem.css('display', 'none');\r\n    };\r\n  });\r\n\r\n  ngFileUpload.directive('ngfDropAvailable', ['$parse', '$timeout', 'Upload', function ($parse, $timeout, Upload) {\r\n    return function (scope, elem, attr) {\r\n      if (dropAvailable()) {\r\n        var model = $parse(Upload.attrGetter('ngfDropAvailable', attr));\r\n        $timeout(function () {\r\n          model(scope);\r\n          if (model.assign) {\r\n            model.assign(scope, true);\r\n          }\r\n        });\r\n      }\r\n    };\r\n  }]);\r\n\r\n  function linkDrop(scope, elem, attr, ngModel, $parse, $timeout, $window, upload, $http, $q) {\r\n    var available = dropAvailable();\r\n\r\n    var attrGetter = function (name, scope, params) {\r\n      return upload.attrGetter(name, attr, scope, params);\r\n    };\r\n\r\n    if (attrGetter('dropAvailable')) {\r\n      $timeout(function () {\r\n        if (scope[attrGetter('dropAvailable')]) {\r\n          scope[attrGetter('dropAvailable')].value = available;\r\n        } else {\r\n          scope[attrGetter('dropAvailable')] = available;\r\n        }\r\n      });\r\n    }\r\n    if (!available) {\r\n      if (attrGetter('ngfHideOnDropNotAvailable', scope) === true) {\r\n        elem.css('display', 'none');\r\n      }\r\n      return;\r\n    }\r\n\r\n    function isDisabled() {\r\n      return elem.attr('disabled') || attrGetter('ngfDropDisabled', scope);\r\n    }\r\n\r\n    if (attrGetter('ngfSelect') == null) {\r\n      upload.registerModelChangeValidator(ngModel, attr, scope);\r\n    }\r\n\r\n    var leaveTimeout = null;\r\n    var stopPropagation = $parse(attrGetter('ngfStopPropagation'));\r\n    var dragOverDelay = 1;\r\n    var actualDragOverClass;\r\n\r\n    elem[0].addEventListener('dragover', function (evt) {\r\n      if (isDisabled() || !upload.shouldUpdateOn('drop', attr, scope)) return;\r\n      evt.preventDefault();\r\n      if (stopPropagation(scope)) evt.stopPropagation();\r\n      // handling dragover events from the Chrome download bar\r\n      if (navigator.userAgent.indexOf('Chrome') > -1) {\r\n        var b = evt.dataTransfer.effectAllowed;\r\n        evt.dataTransfer.dropEffect = ('move' === b || 'linkMove' === b) ? 'move' : 'copy';\r\n      }\r\n      $timeout.cancel(leaveTimeout);\r\n      if (!actualDragOverClass) {\r\n        actualDragOverClass = 'C';\r\n        calculateDragOverClass(scope, attr, evt, function (clazz) {\r\n          actualDragOverClass = clazz;\r\n          elem.addClass(actualDragOverClass);\r\n          attrGetter('ngfDrag', scope, {$isDragging: true, $class: actualDragOverClass, $event: evt});\r\n        });\r\n      }\r\n    }, false);\r\n    elem[0].addEventListener('dragenter', function (evt) {\r\n      if (isDisabled() || !upload.shouldUpdateOn('drop', attr, scope)) return;\r\n      evt.preventDefault();\r\n      if (stopPropagation(scope)) evt.stopPropagation();\r\n    }, false);\r\n    elem[0].addEventListener('dragleave', function (evt) {\r\n      if (isDisabled() || !upload.shouldUpdateOn('drop', attr, scope)) return;\r\n      evt.preventDefault();\r\n      if (stopPropagation(scope)) evt.stopPropagation();\r\n      leaveTimeout = $timeout(function () {\r\n        if (actualDragOverClass) elem.removeClass(actualDragOverClass);\r\n        actualDragOverClass = null;\r\n        attrGetter('ngfDrag', scope, {$isDragging: false, $event: evt});\r\n      }, dragOverDelay || 100);\r\n    }, false);\r\n    elem[0].addEventListener('drop', function (evt) {\r\n      if (isDisabled() || !upload.shouldUpdateOn('drop', attr, scope)) return;\r\n      evt.preventDefault();\r\n      if (stopPropagation(scope)) evt.stopPropagation();\r\n      if (actualDragOverClass) elem.removeClass(actualDragOverClass);\r\n      actualDragOverClass = null;\r\n      extractFilesAndUpdateModel(evt.dataTransfer, evt, 'dropUrl');\r\n    }, false);\r\n    elem[0].addEventListener('paste', function (evt) {\r\n      if (navigator.userAgent.toLowerCase().indexOf('firefox') > -1 &&\r\n        attrGetter('ngfEnableFirefoxPaste', scope)) {\r\n        evt.preventDefault();\r\n      }\r\n      if (isDisabled() || !upload.shouldUpdateOn('paste', attr, scope)) return;\r\n      extractFilesAndUpdateModel(evt.clipboardData || evt.originalEvent.clipboardData, evt, 'pasteUrl');\r\n    }, false);\r\n\r\n    if (navigator.userAgent.toLowerCase().indexOf('firefox') > -1 &&\r\n      attrGetter('ngfEnableFirefoxPaste', scope)) {\r\n      elem.attr('contenteditable', true);\r\n      elem.on('keypress', function (e) {\r\n        if (!e.metaKey && !e.ctrlKey) {\r\n          e.preventDefault();\r\n        }\r\n      });\r\n    }\r\n\r\n    function extractFilesAndUpdateModel(source, evt, updateOnType) {\r\n      if (!source) return;\r\n      // html needs to be calculated on the same process otherwise the data will be wiped\r\n      // after promise resolve or setTimeout.\r\n      var html;\r\n      try {\r\n        html = source && source.getData && source.getData('text/html');\r\n      } catch (e) {/* Fix IE11 that throw error calling getData */\r\n      }\r\n      extractFiles(source.items, source.files, attrGetter('ngfAllowDir', scope) !== false,\r\n        attrGetter('multiple') || attrGetter('ngfMultiple', scope)).then(function (files) {\r\n        if (files.length) {\r\n          updateModel(files, evt);\r\n        } else {\r\n          extractFilesFromHtml(updateOnType, html).then(function (files) {\r\n            updateModel(files, evt);\r\n          });\r\n        }\r\n      });\r\n    }\r\n\r\n    function updateModel(files, evt) {\r\n      upload.updateModel(ngModel, attr, scope, attrGetter('ngfChange') || attrGetter('ngfDrop'), files, evt);\r\n    }\r\n\r\n    function extractFilesFromHtml(updateOn, html) {\r\n      if (!upload.shouldUpdateOn(updateOn, attr, scope) || typeof html !== 'string') return upload.rejectPromise([]);\r\n      var urls = [];\r\n      html.replace(/<(img src|img [^>]* src) *=\\\"([^\\\"]*)\\\"/gi, function (m, n, src) {\r\n        urls.push(src);\r\n      });\r\n      var promises = [], files = [];\r\n      if (urls.length) {\r\n        angular.forEach(urls, function (url) {\r\n          promises.push(upload.urlToBlob(url).then(function (blob) {\r\n            files.push(blob);\r\n          }));\r\n        });\r\n        var defer = $q.defer();\r\n        $q.all(promises).then(function () {\r\n          defer.resolve(files);\r\n        }, function (e) {\r\n          defer.reject(e);\r\n        });\r\n        return defer.promise;\r\n      }\r\n      return upload.emptyPromise();\r\n    }\r\n\r\n    function calculateDragOverClass(scope, attr, evt, callback) {\r\n      var obj = attrGetter('ngfDragOverClass', scope, {$event: evt}), dClass = 'dragover';\r\n      if (angular.isString(obj)) {\r\n        dClass = obj;\r\n      } else if (obj) {\r\n        if (obj.delay) dragOverDelay = obj.delay;\r\n        if (obj.accept || obj.reject) {\r\n          var items = evt.dataTransfer.items;\r\n          if (items == null || !items.length) {\r\n            dClass = obj.accept;\r\n          } else {\r\n            var pattern = obj.pattern || attrGetter('ngfPattern', scope, {$event: evt});\r\n            var len = items.length;\r\n            while (len--) {\r\n              if (!upload.validatePattern(items[len], pattern)) {\r\n                dClass = obj.reject;\r\n                break;\r\n              } else {\r\n                dClass = obj.accept;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n      callback(dClass);\r\n    }\r\n\r\n    function extractFiles(items, fileList, allowDir, multiple) {\r\n      var maxFiles = upload.getValidationAttr(attr, scope, 'maxFiles');\r\n      if (maxFiles == null) {\r\n        maxFiles = Number.MAX_VALUE;\r\n      }\r\n      var maxTotalSize = upload.getValidationAttr(attr, scope, 'maxTotalSize');\r\n      if (maxTotalSize == null) {\r\n        maxTotalSize = Number.MAX_VALUE;\r\n      }\r\n      var includeDir = attrGetter('ngfIncludeDir', scope);\r\n      var files = [], totalSize = 0;\r\n\r\n      function traverseFileTree(entry, path) {\r\n        var defer = $q.defer();\r\n        if (entry != null) {\r\n          if (entry.isDirectory) {\r\n            var promises = [upload.emptyPromise()];\r\n            if (includeDir) {\r\n              var file = {type: 'directory'};\r\n              file.name = file.path = (path || '') + entry.name;\r\n              files.push(file);\r\n            }\r\n            var dirReader = entry.createReader();\r\n            var entries = [];\r\n            var readEntries = function () {\r\n              dirReader.readEntries(function (results) {\r\n                try {\r\n                  if (!results.length) {\r\n                    angular.forEach(entries.slice(0), function (e) {\r\n                      if (files.length <= maxFiles && totalSize <= maxTotalSize) {\r\n                        promises.push(traverseFileTree(e, (path ? path : '') + entry.name + '/'));\r\n                      }\r\n                    });\r\n                    $q.all(promises).then(function () {\r\n                      defer.resolve();\r\n                    }, function (e) {\r\n                      defer.reject(e);\r\n                    });\r\n                  } else {\r\n                    entries = entries.concat(Array.prototype.slice.call(results || [], 0));\r\n                    readEntries();\r\n                  }\r\n                } catch (e) {\r\n                  defer.reject(e);\r\n                }\r\n              }, function (e) {\r\n                defer.reject(e);\r\n              });\r\n            };\r\n            readEntries();\r\n          } else {\r\n            entry.file(function (file) {\r\n              try {\r\n                file.path = (path ? path : '') + file.name;\r\n                if (includeDir) {\r\n                  file = upload.rename(file, file.path);\r\n                }\r\n                files.push(file);\r\n                totalSize += file.size;\r\n                defer.resolve();\r\n              } catch (e) {\r\n                defer.reject(e);\r\n              }\r\n            }, function (e) {\r\n              defer.reject(e);\r\n            });\r\n          }\r\n        }\r\n        return defer.promise;\r\n      }\r\n\r\n      var promises = [upload.emptyPromise()];\r\n\r\n      if (items && items.length > 0 && $window.location.protocol !== 'file:') {\r\n        for (var i = 0; i < items.length; i++) {\r\n          if (items[i].webkitGetAsEntry && items[i].webkitGetAsEntry() && items[i].webkitGetAsEntry().isDirectory) {\r\n            var entry = items[i].webkitGetAsEntry();\r\n            if (entry.isDirectory && !allowDir) {\r\n              continue;\r\n            }\r\n            if (entry != null) {\r\n              promises.push(traverseFileTree(entry));\r\n            }\r\n          } else {\r\n            var f = items[i].getAsFile();\r\n            if (f != null) {\r\n              files.push(f);\r\n              totalSize += f.size;\r\n            }\r\n          }\r\n          if (files.length > maxFiles || totalSize > maxTotalSize ||\r\n            (!multiple && files.length > 0)) break;\r\n        }\r\n      } else {\r\n        if (fileList != null) {\r\n          for (var j = 0; j < fileList.length; j++) {\r\n            var file = fileList.item(j);\r\n            if (file.type || file.size > 0) {\r\n              files.push(file);\r\n              totalSize += file.size;\r\n            }\r\n            if (files.length > maxFiles || totalSize > maxTotalSize ||\r\n              (!multiple && files.length > 0)) break;\r\n          }\r\n        }\r\n      }\r\n\r\n      var defer = $q.defer();\r\n      $q.all(promises).then(function () {\r\n        if (!multiple && !includeDir && files.length) {\r\n          var i = 0;\r\n          while (files[i] && files[i].type === 'directory') i++;\r\n          defer.resolve([files[i]]);\r\n        } else {\r\n          defer.resolve(files);\r\n        }\r\n      }, function (e) {\r\n        defer.reject(e);\r\n      });\r\n\r\n      return defer.promise;\r\n    }\r\n  }\r\n\r\n  function dropAvailable() {\r\n    var div = document.createElement('div');\r\n    return ('draggable' in div) && ('ondrop' in div) && !/Edge\\/12./i.test(navigator.userAgent);\r\n  }\r\n\r\n})();\r\n\r\n// customized version of https://github.com/exif-js/exif-js\r\nngFileUpload.service('UploadExif', ['UploadResize', '$q', function (UploadResize, $q) {\r\n  var upload = UploadResize;\r\n\r\n  upload.isExifSupported = function () {\r\n    return window.FileReader && new FileReader().readAsArrayBuffer && upload.isResizeSupported();\r\n  };\r\n\r\n  function applyTransform(ctx, orientation, width, height) {\r\n    switch (orientation) {\r\n      case 2:\r\n        return ctx.transform(-1, 0, 0, 1, width, 0);\r\n      case 3:\r\n        return ctx.transform(-1, 0, 0, -1, width, height);\r\n      case 4:\r\n        return ctx.transform(1, 0, 0, -1, 0, height);\r\n      case 5:\r\n        return ctx.transform(0, 1, 1, 0, 0, 0);\r\n      case 6:\r\n        return ctx.transform(0, 1, -1, 0, height, 0);\r\n      case 7:\r\n        return ctx.transform(0, -1, -1, 0, height, width);\r\n      case 8:\r\n        return ctx.transform(0, -1, 1, 0, 0, width);\r\n    }\r\n  }\r\n\r\n  upload.readOrientation = function (file) {\r\n    var defer = $q.defer();\r\n    var reader = new FileReader();\r\n    var slicedFile = file.slice ? file.slice(0, 64 * 1024) : file;\r\n    reader.readAsArrayBuffer(slicedFile);\r\n    reader.onerror = function (e) {\r\n      return defer.reject(e);\r\n    };\r\n    reader.onload = function (e) {\r\n      var result = {orientation: 1};\r\n      var view = new DataView(this.result);\r\n      if (view.getUint16(0, false) !== 0xFFD8) return defer.resolve(result);\r\n\r\n      var length = view.byteLength,\r\n        offset = 2;\r\n      while (offset < length) {\r\n        var marker = view.getUint16(offset, false);\r\n        offset += 2;\r\n        if (marker === 0xFFE1) {\r\n          if (view.getUint32(offset += 2, false) !== 0x45786966) return defer.resolve(result);\r\n\r\n          var little = view.getUint16(offset += 6, false) === 0x4949;\r\n          offset += view.getUint32(offset + 4, little);\r\n          var tags = view.getUint16(offset, little);\r\n          offset += 2;\r\n          for (var i = 0; i < tags; i++)\r\n            if (view.getUint16(offset + (i * 12), little) === 0x0112) {\r\n              var orientation = view.getUint16(offset + (i * 12) + 8, little);\r\n              if (orientation >= 2 && orientation <= 8) {\r\n                view.setUint16(offset + (i * 12) + 8, 1, little);\r\n                result.fixedArrayBuffer = e.target.result;\r\n              }\r\n              result.orientation = orientation;\r\n              return defer.resolve(result);\r\n            }\r\n        } else if ((marker & 0xFF00) !== 0xFF00) break;\r\n        else offset += view.getUint16(offset, false);\r\n      }\r\n      return defer.resolve(result);\r\n    };\r\n    return defer.promise;\r\n  };\r\n\r\n  function arrayBufferToBase64(buffer) {\r\n    var binary = '';\r\n    var bytes = new Uint8Array(buffer);\r\n    var len = bytes.byteLength;\r\n    for (var i = 0; i < len; i++) {\r\n      binary += String.fromCharCode(bytes[i]);\r\n    }\r\n    return window.btoa(binary);\r\n  }\r\n\r\n  upload.applyExifRotation = function (file) {\r\n    if (file.type.indexOf('image/jpeg') !== 0) {\r\n      return upload.emptyPromise(file);\r\n    }\r\n\r\n    var deferred = $q.defer();\r\n    upload.readOrientation(file).then(function (result) {\r\n      if (result.orientation < 2 || result.orientation > 8) {\r\n        return deferred.resolve(file);\r\n      }\r\n      upload.dataUrl(file, true).then(function (url) {\r\n        var canvas = document.createElement('canvas');\r\n        var img = document.createElement('img');\r\n\r\n        img.onload = function () {\r\n          try {\r\n            canvas.width = result.orientation > 4 ? img.height : img.width;\r\n            canvas.height = result.orientation > 4 ? img.width : img.height;\r\n            var ctx = canvas.getContext('2d');\r\n            applyTransform(ctx, result.orientation, img.width, img.height);\r\n            ctx.drawImage(img, 0, 0);\r\n            var dataUrl = canvas.toDataURL(file.type || 'image/WebP', 0.934);\r\n            dataUrl = upload.restoreExif(arrayBufferToBase64(result.fixedArrayBuffer), dataUrl);\r\n            var blob = upload.dataUrltoBlob(dataUrl, file.name);\r\n            deferred.resolve(blob);\r\n          } catch (e) {\r\n            return deferred.reject(e);\r\n          }\r\n        };\r\n        img.onerror = function () {\r\n          deferred.reject();\r\n        };\r\n        img.src = url;\r\n      }, function (e) {\r\n        deferred.reject(e);\r\n      });\r\n    }, function (e) {\r\n      deferred.reject(e);\r\n    });\r\n    return deferred.promise;\r\n  };\r\n\r\n  upload.restoreExif = function (orig, resized) {\r\n    var ExifRestorer = {};\r\n\r\n    ExifRestorer.KEY_STR = 'ABCDEFGHIJKLMNOP' +\r\n      'QRSTUVWXYZabcdef' +\r\n      'ghijklmnopqrstuv' +\r\n      'wxyz0123456789+/' +\r\n      '=';\r\n\r\n    ExifRestorer.encode64 = function (input) {\r\n      var output = '',\r\n        chr1, chr2, chr3 = '',\r\n        enc1, enc2, enc3, enc4 = '',\r\n        i = 0;\r\n\r\n      do {\r\n        chr1 = input[i++];\r\n        chr2 = input[i++];\r\n        chr3 = input[i++];\r\n\r\n        enc1 = chr1 >> 2;\r\n        enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);\r\n        enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);\r\n        enc4 = chr3 & 63;\r\n\r\n        if (isNaN(chr2)) {\r\n          enc3 = enc4 = 64;\r\n        } else if (isNaN(chr3)) {\r\n          enc4 = 64;\r\n        }\r\n\r\n        output = output +\r\n          this.KEY_STR.charAt(enc1) +\r\n          this.KEY_STR.charAt(enc2) +\r\n          this.KEY_STR.charAt(enc3) +\r\n          this.KEY_STR.charAt(enc4);\r\n        chr1 = chr2 = chr3 = '';\r\n        enc1 = enc2 = enc3 = enc4 = '';\r\n      } while (i < input.length);\r\n\r\n      return output;\r\n    };\r\n\r\n    ExifRestorer.restore = function (origFileBase64, resizedFileBase64) {\r\n      if (origFileBase64.match('data:image/jpeg;base64,')) {\r\n        origFileBase64 = origFileBase64.replace('data:image/jpeg;base64,', '');\r\n      }\r\n\r\n      var rawImage = this.decode64(origFileBase64);\r\n      var segments = this.slice2Segments(rawImage);\r\n\r\n      var image = this.exifManipulation(resizedFileBase64, segments);\r\n\r\n      return 'data:image/jpeg;base64,' + this.encode64(image);\r\n    };\r\n\r\n\r\n    ExifRestorer.exifManipulation = function (resizedFileBase64, segments) {\r\n      var exifArray = this.getExifArray(segments),\r\n        newImageArray = this.insertExif(resizedFileBase64, exifArray);\r\n      return new Uint8Array(newImageArray);\r\n    };\r\n\r\n\r\n    ExifRestorer.getExifArray = function (segments) {\r\n      var seg;\r\n      for (var x = 0; x < segments.length; x++) {\r\n        seg = segments[x];\r\n        if (seg[0] === 255 & seg[1] === 225) //(ff e1)\r\n        {\r\n          return seg;\r\n        }\r\n      }\r\n      return [];\r\n    };\r\n\r\n\r\n    ExifRestorer.insertExif = function (resizedFileBase64, exifArray) {\r\n      var imageData = resizedFileBase64.replace('data:image/jpeg;base64,', ''),\r\n        buf = this.decode64(imageData),\r\n        separatePoint = buf.indexOf(255, 3),\r\n        mae = buf.slice(0, separatePoint),\r\n        ato = buf.slice(separatePoint),\r\n        array = mae;\r\n\r\n      array = array.concat(exifArray);\r\n      array = array.concat(ato);\r\n      return array;\r\n    };\r\n\r\n\r\n    ExifRestorer.slice2Segments = function (rawImageArray) {\r\n      var head = 0,\r\n        segments = [];\r\n\r\n      while (1) {\r\n        if (rawImageArray[head] === 255 & rawImageArray[head + 1] === 218) {\r\n          break;\r\n        }\r\n        if (rawImageArray[head] === 255 & rawImageArray[head + 1] === 216) {\r\n          head += 2;\r\n        }\r\n        else {\r\n          var length = rawImageArray[head + 2] * 256 + rawImageArray[head + 3],\r\n            endPoint = head + length + 2,\r\n            seg = rawImageArray.slice(head, endPoint);\r\n          segments.push(seg);\r\n          head = endPoint;\r\n        }\r\n        if (head > rawImageArray.length) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      return segments;\r\n    };\r\n\r\n\r\n    ExifRestorer.decode64 = function (input) {\r\n      var chr1, chr2, chr3 = '',\r\n        enc1, enc2, enc3, enc4 = '',\r\n        i = 0,\r\n        buf = [];\r\n\r\n      // remove all characters that are not A-Z, a-z, 0-9, +, /, or =\r\n      var base64test = /[^A-Za-z0-9\\+\\/\\=]/g;\r\n      if (base64test.exec(input)) {\r\n        console.log('There were invalid base64 characters in the input text.\\n' +\r\n          'Valid base64 characters are A-Z, a-z, 0-9, ' + ', ' / ',and \"=\"\\n' +\r\n          'Expect errors in decoding.');\r\n      }\r\n      input = input.replace(/[^A-Za-z0-9\\+\\/\\=]/g, '');\r\n\r\n      do {\r\n        enc1 = this.KEY_STR.indexOf(input.charAt(i++));\r\n        enc2 = this.KEY_STR.indexOf(input.charAt(i++));\r\n        enc3 = this.KEY_STR.indexOf(input.charAt(i++));\r\n        enc4 = this.KEY_STR.indexOf(input.charAt(i++));\r\n\r\n        chr1 = (enc1 << 2) | (enc2 >> 4);\r\n        chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);\r\n        chr3 = ((enc3 & 3) << 6) | enc4;\r\n\r\n        buf.push(chr1);\r\n\r\n        if (enc3 !== 64) {\r\n          buf.push(chr2);\r\n        }\r\n        if (enc4 !== 64) {\r\n          buf.push(chr3);\r\n        }\r\n\r\n        chr1 = chr2 = chr3 = '';\r\n        enc1 = enc2 = enc3 = enc4 = '';\r\n\r\n      } while (i < input.length);\r\n\r\n      return buf;\r\n    };\r\n\r\n    return ExifRestorer.restore(orig, resized);  //<= EXIF\r\n  };\r\n\r\n  return upload;\r\n}]);\r\n\r\n"]}